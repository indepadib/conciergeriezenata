<!--
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Guides – Conciergerie Zenata</title>
  <style>
    body{font-family:system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#0f172a;background:#fff}
    .wrap{max-width:1040px;margin:0 auto;padding:16px}
    .card{border:1px solid #e2e8f0;border-radius:16px;overflow:hidden;background:#f8fafc}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #e2e8f0;font-size:16px}
    .content{padding:14px}
    label{font-size:12px;color:#475569;display:block;margin-bottom:6px}
    input{width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
    .grid{display:grid;gap:12px}
    .grid2{grid-template-columns:1fr 1fr}
    .btn{display:inline-flex;gap:8px;padding:10px 14px;border:1px solid #0f172a;border-radius:12px;background:#0f172a;color:#fff;cursor:pointer}
    .muted{font-size:12px;color:#475569}
    .pill{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid #e2e8f0;border-radius:999px;font-size:12px;margin:4px 6px 0 0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // --- Helpers appelant TES Netlify Functions (serveur) ---

  async function serverUploadGuide(slug, guide){
    const res = await fetch("/.netlify/functions/upload-guide", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ slug, guide })
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || `HTTP ${res.status}`);
    }
    return await res.json(); // { ok:true, url: "https://.../guides/<slug>.json" }
  }

  async function serverUploadImage(file, slug){
    const ext = (file.name.split(".").pop() || "webp").toLowerCase();
    const url = `/.netlify/functions/upload-image?slug=${encodeURIComponent(slug)}&ext=${encodeURIComponent(ext)}`;
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": file.type || "application/octet-stream" },
      body: file
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || `HTTP ${res.status}`);
    }
    return await res.json(); // { ok:true, url: "https://.../guide-assets/covers/<slug>.<ext>" }
  }

  // --- Ton modèle de guide (inchangé) ---
  function guideFromForm(){
    const get = id => document.getElementById(id).value.trim();
    const token = get('f-token');
    return {
      id: 'prop_'+Date.now(),
      slug: get('f-slug'),
      brand: { name:'Conciergerie Zenata', logoUrl:'/logo/logo_officiel_couleur_picto.png', supportEmail:'hello@conciergeriezenata.com', site: location.origin },
      cover: { imageUrl:get('f-cover'), caption:{ fr:'' } },
      name: get('f-name'),
      address: get('f-address'),
      city: 'Casablanca',
      arrival: { fr:{ checkin_from:get('f-checkin') || '15:00', self_checkin:true, doorCode:get('f-door'), parking:get('f-parking'), wifi:{ ssid:get('f-ssid'), password:get('f-wifi') }, notes:[] } },
      rules: { fr:{ items:[] } },
      departure: { fr:{ checkout_until:'11:00', steps:[] } },
      amenities: [],
      essentials: { fr:{ electricity:'', water:'', gas:'', emergency:[] } },
      neighborhood: { fr:{ intro:'', places:[] } },
      recommendations: { fr:{ intro:'', tips:[] } },
      __sensitive: token ? { token } : undefined
    };
  }

  function renderPreview(g, token){
    const a = g.arrival?.fr || {};
    const allow = g.__sensitive?.token ? (token === g.__sensitive.token) : true;
    const door = allow ? (a.doorCode||'') : '•••• (masqué)';
    return `
      <div class="grid" style="gap:10px">
        <div class="card"><h2>${g.name||'Sans nom'}</h2><div class="content">${g.address||''}</div></div>
        <div class="card"><div class="content">
          <img src="${g.cover?.imageUrl||''}" alt="" style="width:100%;height:260px;object-fit:cover;border-radius:12px;border:1px solid #e2e8f0">
        </div></div>
        <div class="grid" style="grid-template-columns:1fr 1fr 1fr;gap:10px">
          <div class="card"><div class="content"><div class="muted">Wi-Fi</div><b>${(a.wifi?.ssid||'')}${a.wifi?.password ? ' • '+a.wifi.password:''}</b></div></div>
          <div class="card"><div class="content"><div class="muted">Code porte</div><b>${door}</b></div></div>
          <div class="card"><div class="content"><div class="muted">Check-in</div><b>${a.checkin_from||''}</b></div></div>
        </div>
      </div>`;
  }

  // --- Bind UI ---
  document.addEventListener('DOMContentLoaded', ()=>{
    const prev = document.getElementById('preview');
    const tokenInput = document.getElementById('f-token');
    const saveMsg = document.getElementById('save-msg');

    function refresh(){ prev.innerHTML = renderPreview(guideFromForm(), tokenInput.value.trim()); }
    Array.from(document.querySelectorAll('input')).forEach(i => i.addEventListener('input', refresh));
    refresh();

    // Upload image (envoie à la Netlify Function -> remplit #f-cover)
    const fileInput = document.getElementById('f-cover-file');
    if (fileInput) {
      fileInput.addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        try{
          const slug = (document.getElementById('f-slug').value.trim() || `temp-${Date.now()}`).replace(/[^a-z0-9-]/gi,'-').toLowerCase();
          const r = await serverUploadImage(file, slug);
          document.getElementById('f-cover').value = r.url || '';
          saveMsg.textContent = '✅ Image uploadée';
          refresh();
        }catch(err){
          document.getElementById('f-cover').value = '';
          saveMsg.textContent = '❌ Upload image: ' + (err.message || err);
        }
      });
    }

    // Publier JSON (via Netlify Function)
    document.getElementById('btn-publish').addEventListener('click', async ()=>{
      const g = guideFromForm();
      const slug = g.slug;
      if(!slug){ saveMsg.textContent = 'Slug requis'; return; }
      try{
        const r = await serverUploadGuide(slug, g);
        saveMsg.textContent = `✅ Publié : ${r.url}`;
      }catch(e){
        saveMsg.textContent = `❌ ${e.message || e}`;
      }
    });
  });
</script>


</head>
<body>
  <div class="wrap">
    <h1>Admin – Nouveau Guide</h1>
    <div class="grid" style="grid-template-columns:1.1fr .9fr;gap:16px">
      <div class="card">
        <h2>Formulaire</h2>
        <div class="content grid grid2">
          <div><label>Nom</label><input id="f-name" placeholder="Azure 12B – Suite Terrasse"></div>
          <div><label>Slug</label><input id="f-slug" placeholder="zenata-azure-12b"></div>
          <div style="grid-column:1/3"><label>Adresse</label><input id="f-address" placeholder="Résidence Azure, Zenata Éco-Cité, Mohammédia"></div>
          <div style="grid-column:1/3"><label>Image de couverture (URL)</label><input id="f-cover" placeholder="https://.../photo.webp"></div>
          <div style="grid-column:1/3"> <label>Image de couverture</label> <input type="file" id="f-cover-file" accept="image/*"></div>
          <div><label>Check-in dès</label><input id="f-checkin" placeholder="15:00"></div>
          <div><label>Code porte (sensible)</label><input id="f-door" placeholder="7942#"></div>
          <div><label>Parking</label><input id="f-parking" placeholder="P2, place 18"></div>
          <div><label>Wi-Fi SSID</label><input id="f-ssid" placeholder="Azure12B"></div>
          <div><label>Wi-Fi Password</label><input id="f-wifi" placeholder="Zenata2025"></div>
          <div style="grid-column:1/3"><label>Jeton d’accès (pour révéler le code)</label><input id="f-token" placeholder="A1B2C3 (optionnel)"></div>
          <div style="grid-column:1/3;display:flex;gap:8px;margin-top:4px">
            <button class="btn" id="btn-publish">Publier</button>
            <div class="muted" id="save-msg"></div>
          </div>
          <div style="grid-column:1/3" class="muted">
            Le JSON sera enregistré dans Supabase Storage (<b>bucket public “guides”</b>) sous <code>guides/slug.json</code>.
          </div>
        </div>
      </div>
      <div class="card"><h2>Aperçu</h2><div class="content" id="preview"></div></div>
    </div>
  </div>
</body>
</html> -->
<!doctype html>
function renderPreview(g){
const a = g.arrival?.fr || {}; const rules=g.rules?.fr?.items||[]; const door=a.doorCode||'••••';
const ams = g.amenities||[];
return `
<div class="vstack">
<div class="hero"><img src="${g.cover?.imageUrl||''}"><div class="overlay"></div><div class="title"><span class="badge">Aperçu</span><h1>${g.name||'Sans nom'}</h1></div></div>
<div class="grid grid-3">
${g.address? `<div class="tile"><div class="k">Adresse</div><b>${g.address}</b></div>`:''}
${(a.wifi?.ssid||a.wifi?.password)? `<div class="tile"><div class="k">Wi‑Fi</div><b>${a.wifi?.ssid||''}${a.wifi?.password? ' • '+a.wifi.password:''}</b></div>`:''}
${door? `<div class="tile"><div class="k">Code porte</div><b>${door}</b></div>`:''}
</div>
<div class="grid grid-2">
<div class="vstack">
<div class="card"><h2>Arrivée & Check‑in</h2><div class="content">${a.checkin_from? `<div><span class="k">À partir de</span> <b>${a.checkin_from}</b></div>`:''}${a.parking? `<div><span class="k">Parking</span> <b>${a.parking}</b></div>`:''}${(a.notes||[]).length? `<ul>${a.notes.map(n=>`<li>${n}</li>`).join('')}</ul>`:''}</div></div>
${rules.length? `<div class="card"><h2>Règles</h2><div class="content"><ul>${rules.map(r=>`<li>${r}</li>`).join('')}</ul></div></div>`:''}
</div>
<div class="vstack">
${(ams||[]).length? `<div class="card"><h2>Équipements</h2><div class="content">${ams.map(a=>`<span class="pill">${a.label}</span>`).join('')}</div></div>`:''}
</div>
</div>
</div>`
}


async function serverUploadGuide(slug, guide){
const r = await fetch('/.netlify/functions/upload-guide',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ slug, guide })});
if(!r.ok) throw new Error(await r.text()); return await r.json();
}
async function serverUploadImage(file, slug){
const ext=(file.name.split('.').pop()||'webp').toLowerCase();
const r = await fetch(`/.netlify/functions/upload-image?slug=${encodeURIComponent(slug)}&ext=${encodeURIComponent(ext)}`,{ method:'POST', headers:{ 'Content-Type': file.type||'application/octet-stream' }, body:file });
if(!r.ok) throw new Error(await r.text()); return await r.json();
}


document.addEventListener('DOMContentLoaded', ()=>{
const prev = document.getElementById('preview'); const msg = document.getElementById('save-msg');
const refresh = ()=> prev.innerHTML = renderPreview(guideFromForm());
Array.from(document.querySelectorAll('input,textarea,select')).forEach(el=> el.addEventListener('input', refresh)); refresh();


document.getElementById('f-cover-file').addEventListener('change', async (e)=>{
const file = e.target.files?.[0]; if(!file) return; const slug=(document.getElementById('f-slug').value.trim()||`temp-${Date.now()}`).replace(/[^a-z0-9-]/gi,'-').toLowerCase();
try{ const res=await serverUploadImage(file, slug); document.getElementById('f-cover').value=res.url||''; msg.textContent='✅ Image uploadée'; refresh() }catch(err){ msg.textContent='❌ '+(err.message||err) }
});


document.getElementById('btn-publish').addEventListener('click', async ()=>{
const g = guideFromForm(); const slug = g.slug; if(!slug){ msg.textContent='Slug requis'; return }
try{ const res = await serverUploadGuide(slug, g); msg.innerHTML = `✅ Publié: <a href="/guide/${slug}" target="_blank">ouvrir</a>` }catch(err){ msg.textContent='❌ '+(err.message||err) }
});
});
</script>
</body>
</html>
