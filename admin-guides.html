<!--
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Guides – Conciergerie Zenata</title>
  <style>
    body{font-family:system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#0f172a;background:#fff}
    .wrap{max-width:1040px;margin:0 auto;padding:16px}
    .card{border:1px solid #e2e8f0;border-radius:16px;overflow:hidden;background:#f8fafc}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid #e2e8f0;font-size:16px}
    .content{padding:14px}
    label{font-size:12px;color:#475569;display:block;margin-bottom:6px}
    input{width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
    .grid{display:grid;gap:12px}
    .grid2{grid-template-columns:1fr 1fr}
    .btn{display:inline-flex;gap:8px;padding:10px 14px;border:1px solid #0f172a;border-radius:12px;background:#0f172a;color:#fff;cursor:pointer}
    .muted{font-size:12px;color:#475569}
    .pill{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid #e2e8f0;border-radius:999px;font-size:12px;margin:4px 6px 0 0}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // --- Helpers appelant TES Netlify Functions (serveur) ---

  async function serverUploadGuide(slug, guide){
    const res = await fetch("/.netlify/functions/upload-guide", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ slug, guide })
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || `HTTP ${res.status}`);
    }
    return await res.json(); // { ok:true, url: "https://.../guides/<slug>.json" }
  }

  async function serverUploadImage(file, slug){
    const ext = (file.name.split(".").pop() || "webp").toLowerCase();
    const url = `/.netlify/functions/upload-image?slug=${encodeURIComponent(slug)}&ext=${encodeURIComponent(ext)}`;
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": file.type || "application/octet-stream" },
      body: file
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || `HTTP ${res.status}`);
    }
    return await res.json(); // { ok:true, url: "https://.../guide-assets/covers/<slug>.<ext>" }
  }

  // --- Ton modèle de guide (inchangé) ---
  function guideFromForm(){
    const get = id => document.getElementById(id).value.trim();
    const token = get('f-token');
    return {
      id: 'prop_'+Date.now(),
      slug: get('f-slug'),
      brand: { name:'Conciergerie Zenata', logoUrl:'/logo/logo_officiel_couleur_picto.png', supportEmail:'hello@conciergeriezenata.com', site: location.origin },
      cover: { imageUrl:get('f-cover'), caption:{ fr:'' } },
      name: get('f-name'),
      address: get('f-address'),
      city: 'Casablanca',
      arrival: { fr:{ checkin_from:get('f-checkin') || '15:00', self_checkin:true, doorCode:get('f-door'), parking:get('f-parking'), wifi:{ ssid:get('f-ssid'), password:get('f-wifi') }, notes:[] } },
      rules: { fr:{ items:[] } },
      departure: { fr:{ checkout_until:'11:00', steps:[] } },
      amenities: [],
      essentials: { fr:{ electricity:'', water:'', gas:'', emergency:[] } },
      neighborhood: { fr:{ intro:'', places:[] } },
      recommendations: { fr:{ intro:'', tips:[] } },
      __sensitive: token ? { token } : undefined
    };
  }

  function renderPreview(g, token){
    const a = g.arrival?.fr || {};
    const allow = g.__sensitive?.token ? (token === g.__sensitive.token) : true;
    const door = allow ? (a.doorCode||'') : '•••• (masqué)';
    return `
      <div class="grid" style="gap:10px">
        <div class="card"><h2>${g.name||'Sans nom'}</h2><div class="content">${g.address||''}</div></div>
        <div class="card"><div class="content">
          <img src="${g.cover?.imageUrl||''}" alt="" style="width:100%;height:260px;object-fit:cover;border-radius:12px;border:1px solid #e2e8f0">
        </div></div>
        <div class="grid" style="grid-template-columns:1fr 1fr 1fr;gap:10px">
          <div class="card"><div class="content"><div class="muted">Wi-Fi</div><b>${(a.wifi?.ssid||'')}${a.wifi?.password ? ' • '+a.wifi.password:''}</b></div></div>
          <div class="card"><div class="content"><div class="muted">Code porte</div><b>${door}</b></div></div>
          <div class="card"><div class="content"><div class="muted">Check-in</div><b>${a.checkin_from||''}</b></div></div>
        </div>
      </div>`;
  }

  // --- Bind UI ---
  document.addEventListener('DOMContentLoaded', ()=>{
    const prev = document.getElementById('preview');
    const tokenInput = document.getElementById('f-token');
    const saveMsg = document.getElementById('save-msg');

    function refresh(){ prev.innerHTML = renderPreview(guideFromForm(), tokenInput.value.trim()); }
    Array.from(document.querySelectorAll('input')).forEach(i => i.addEventListener('input', refresh));
    refresh();

    // Upload image (envoie à la Netlify Function -> remplit #f-cover)
    const fileInput = document.getElementById('f-cover-file');
    if (fileInput) {
      fileInput.addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        try{
          const slug = (document.getElementById('f-slug').value.trim() || `temp-${Date.now()}`).replace(/[^a-z0-9-]/gi,'-').toLowerCase();
          const r = await serverUploadImage(file, slug);
          document.getElementById('f-cover').value = r.url || '';
          saveMsg.textContent = '✅ Image uploadée';
          refresh();
        }catch(err){
          document.getElementById('f-cover').value = '';
          saveMsg.textContent = '❌ Upload image: ' + (err.message || err);
        }
      });
    }

    // Publier JSON (via Netlify Function)
    document.getElementById('btn-publish').addEventListener('click', async ()=>{
      const g = guideFromForm();
      const slug = g.slug;
      if(!slug){ saveMsg.textContent = 'Slug requis'; return; }
      try{
        const r = await serverUploadGuide(slug, g);
        saveMsg.textContent = `✅ Publié : ${r.url}`;
      }catch(e){
        saveMsg.textContent = `❌ ${e.message || e}`;
      }
    });
  });
</script>


</head>
<body>
  <div class="wrap">
    <h1>Admin – Nouveau Guide</h1>
    <div class="grid" style="grid-template-columns:1.1fr .9fr;gap:16px">
      <div class="card">
        <h2>Formulaire</h2>
        <div class="content grid grid2">
          <div><label>Nom</label><input id="f-name" placeholder="Azure 12B – Suite Terrasse"></div>
          <div><label>Slug</label><input id="f-slug" placeholder="zenata-azure-12b"></div>
          <div style="grid-column:1/3"><label>Adresse</label><input id="f-address" placeholder="Résidence Azure, Zenata Éco-Cité, Mohammédia"></div>
          <div style="grid-column:1/3"><label>Image de couverture (URL)</label><input id="f-cover" placeholder="https://.../photo.webp"></div>
          <div style="grid-column:1/3"> <label>Image de couverture</label> <input type="file" id="f-cover-file" accept="image/*"></div>
          <div><label>Check-in dès</label><input id="f-checkin" placeholder="15:00"></div>
          <div><label>Code porte (sensible)</label><input id="f-door" placeholder="7942#"></div>
          <div><label>Parking</label><input id="f-parking" placeholder="P2, place 18"></div>
          <div><label>Wi-Fi SSID</label><input id="f-ssid" placeholder="Azure12B"></div>
          <div><label>Wi-Fi Password</label><input id="f-wifi" placeholder="Zenata2025"></div>
          <div style="grid-column:1/3"><label>Jeton d’accès (pour révéler le code)</label><input id="f-token" placeholder="A1B2C3 (optionnel)"></div>
          <div style="grid-column:1/3;display:flex;gap:8px;margin-top:4px">
            <button class="btn" id="btn-publish">Publier</button>
            <div class="muted" id="save-msg"></div>
          </div>
          <div style="grid-column:1/3" class="muted">
            Le JSON sera enregistré dans Supabase Storage (<b>bucket public “guides”</b>) sous <code>guides/slug.json</code>.
          </div>
        </div>
      </div>
      <div class="card"><h2>Aperçu</h2><div class="content" id="preview"></div></div>
    </div>
  </div>
</body>
</html> -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin – Édition de Guide | Conciergerie Zenata</title>
  <link rel="icon" href="/logo/logo_officiel_couleur_picto.png"/>
  <style>
    :root{
      --ink:#0B1220; --muted:#6F7782; --line:#E4E9F2;
      --card:#FFFFFF; --accent:#C6A86A;
      --shadow:0 20px 40px rgba(16,24,40,.08);
      --radius:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      background:
        radial-gradient(900px 700px at 20% -10%, #ffffff 0%, #f8f9fc 60%, #eef1f6 100%);
      padding:32px;
    }

    h1{font-size:24px;margin-bottom:12px;}
    h2{font-size:18px;margin-top:40px;margin-bottom:10px;}
    a{text-decoration:none;color:var(--accent)}
    a:hover{text-decoration:underline}

    .header{display:flex;align-items:center;gap:10px;margin-bottom:24px;}
    .header img{height:28px;}
    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:var(--radius);padding:28px;
      max-width:860px;margin:0 auto 24px;box-shadow:var(--shadow);
    }

    form{display:grid;gap:16px;}
    label{font-weight:600;font-size:14px;display:block;margin-bottom:6px;}
    input,textarea{
      width:100%;padding:12px;border:1px solid var(--line);
      border-radius:10px;font-size:14px;background:#fff;
      box-shadow:inset 0 1px 2px rgba(0,0,0,.04);
    }
    textarea{min-height:80px;resize:vertical;}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;}
    .btn{
      appearance:none;border:none;cursor:pointer;
      background:linear-gradient(135deg,#0F172A,#1F2937);
      color:#fff;font-weight:600;font-size:14px;
      border-radius:12px;padding:12px 18px;
      box-shadow:0 6px 14px rgba(0,0,0,.08);
      transition:transform .1s ease, box-shadow .2s ease;
    }
    .btn:hover{box-shadow:0 8px 18px rgba(0,0,0,.12);}
    .btn:active{transform:translateY(1px);}
    .info{color:var(--muted);font-size:13px;}
    .preview{
      border-radius:var(--radius);overflow:hidden;
      margin-top:24px;box-shadow:var(--shadow);
      border:1px solid var(--line);
    }
    .preview iframe{width:100%;height:600px;border:0;}
  </style>
</head>
<body>

  <div class="header">
    <img src="/logo/logo_officiel_couleur_picto.png" alt="CZ">
    <h1>Conciergerie Zenata – <span style="font-weight:400">Admin</span></h1>
  </div>

  <p><a href="/guides.html">← Liste des guides</a></p>

  <div class="card">
    <h2>Éditer le guide <span id="slugLabel"></span></h2>
    <form id="f">
      <div class="row">
        <div>
          <label>Nom</label><input name="name" required>
        </div>
        <div>
          <label>Slug</label><input name="slug" required>
        </div>
      </div>

      <div>
        <label>Adresse</label><input name="address">
      </div>
      <div class="row">
        <div><label>Ville</label><input name="city"></div>
        <div><label>Couverture (URL)</label><input name="coverUrl"></div>
        <div><label>ou charger une image</label><input type="file" id="file"></div>
      </div>

      <div class="row">
        <div><label>Check-in à partir de</label><input name="checkin_from"></div>
        <div><label>Check-out avant</label><input name="checkout_until"></div>
      </div>

      <div class="row">
        <div><label>Code porte (sens.)</label><input name="doorCode"></div>
        <div><label>Jeton d’accès (pour révéler)</label><input name="token"></div>
      </div>

      <div class="row">
        <div><label>Parking</label><input name="parking"></div>
        <div><label>Wi-Fi SSID</label><input name="wifi_ssid"></div>
        <div><label>Wi-Fi Password</label><input name="wifi_password"></div>
      </div>

      <div>
        <label>Règles (une par ligne)</label>
        <textarea name="rules"></textarea>
      </div>

      <div>
        <label>Notes d’arrivée (une par ligne)</label>
        <textarea name="arrivalNotes"></textarea>
      </div>

      <div>
        <label>Équipements (séparés par des virgules)</label>
        <input name="amenities">
      </div>

      <div>
        <label>Contacts d’urgence (JSON court)</label>
        <input name="emergency" placeholder='[{"label":"Police","value":"19"}]'>
      </div>

      <div class="row">
        <div><label>Latitude</label><input name="lat"></div>
        <div><label>Longitude</label><input name="lng"></div>
      </div>

      <button type="submit" class="btn">Publier</button>
      <p class="info">Le lien public sera : <code>/guide/&lt;slug&gt;</code></p>
    </form>
  </div>

<h2>Aperçu</h2>
<div class="preview">
  <iframe id="preview"></iframe>
</div>

<script>
  // On lit le slug et un token si tu l’as saisi dans le formulaire
  function setPreview() {
    const f = document.getElementById('f');
    const slug = (new URLSearchParams(location.search).get('slug')) || (f?.slug?.value || '').trim();
    const token = (f?.token?.value || '').trim(); // le champ "Jeton d’accès (pour révéler)"
    if(!slug) return;

    // Ajout d’un cache-buster pour forcer le rechargement de l’iframe
    const ts = Date.now();
    const url = `/guide/${encodeURIComponent(slug)}${token ? `?token=${encodeURIComponent(token)}` : ''}&ts=${ts}`;
    document.getElementById('preview').src = url;
  }

  // Quand la page charge, on met l’aperçu avec le slug de l’URL
  document.addEventListener('DOMContentLoaded', setPreview);

  // Quand tu modifies le formulaire (slug/token), on met à jour l’aperçu
  document.getElementById('f')?.addEventListener('input', (e)=>{
    if (e.target.name === 'slug' || e.target.name === 'token') setPreview();
  });

  // Après publication, on rafraîchit aussi l’aperçu
  // (si tu as un handler submit existant, ajoute juste setPreview() à la fin)
  document.getElementById('f')?.addEventListener('submit', function(e){
    // ton code de publication...
    // après succès:
    setPreview();
  });
</script>


</body>
</html>
