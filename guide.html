<!--
Guide public premium â€“ version statique sans build
- Fichier: guide.html Ã  placer Ã  la racine du repo (Ã  cÃ´tÃ© de index.html)
- URL finale: https://conciergeriezenata.com/guide/<slug>
- NÃ©cessite un fichier _redirects (Ã  la racine) avec:
    /guide/*   /guide.html?slug=:splat   200

- Lit le JSON public dans Supabase Storage: https://<SUPABASE_URL>/storage/v1/object/public/guides/<slug>.json
- Gestion du token: /guide/<slug>?token=XXXX pour afficher les champs sensibles
- Aucun framework, aucune clÃ© d'API requise pour la lecture (public)

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guide Voyageur â€“ Conciergerie Zenata</title>
  <meta name="theme-color" content="#0f172a"/>
  <style>
    :root{--ink:#0f172a;--muted:#475569;--line:#e2e8f0;--bg:#ffffff;--card:#f8fafc;--brand:#111827}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    .container{max-width:1120px;margin:0 auto;padding:20px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand img{height:28px}
    .badge{font-size:12px;color:var(--muted)}
    .hero{border-radius:20px;overflow:hidden;border:1px solid var(--line);background:#000}
    .hero img{width:100%;height:420px;object-fit:cover;display:block;opacity:.95}
    .grid{display:grid;gap:16px}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .grid-2{grid-template-columns:1.15fr .85fr}
    @media(max-width:960px){.grid-2,.grid-3{grid-template-columns:1fr}}
    .tile{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .tile .k{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:16px}
    .card .content{padding:16px}
    ul{margin:8px 0;padding-left:18px}
    .pill{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;margin:4px 6px 0 0;background:#fff}
    .muted{color:var(--muted)}
    .warn{background:#fffbeb;border:1px solid #fef3c7;color:#92400e;padding:10px 12px;border-radius:12px;font-size:13px}
    .footer{padding:28px 0;text-align:center;color:var(--muted);font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .sr{position:absolute;left:-9999px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header class="container header">
    <div class="brand"><img src="/logo/logo_officiel_couleur_picto.png" alt="CZ"> Conciergerie Zenata</div>
    <div class="badge" id="guideSlug"></div>
  </header>

  <main class="container" id="root">
    <p class="muted">Chargement du guideâ€¦</p>
  </main>

  <footer class="container footer">Â© <span id="year"></span> Conciergerie Zenata</footer>

  <script>
    // === CONFIG â€” mets simplement ton URL Supabase ici ===
    const SUPABASE_URL = "https://ojgchrqtvkwzhjvwwftd.supabase.co"; // <- la tienne
    const GUIDES_BUCKET = "guides";

    const qs = new URL(location.href);
    const slug = (qs.searchParams.get('slug') || location.pathname.split('/').filter(Boolean).pop() || '').trim();
    const token = qs.searchParams.get('token') || '';

    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('guideSlug').textContent = slug ? `#${slug}` : '';

    const root = document.getElementById('root');

    function html(strings, ...vals){ return strings.map((s,i)=>s+(vals[i]??'')).join(''); }

    function section(g){
      const a = g.arrival?.fr || {};
      const allow = g.__sensitive?.token ? (token === g.__sensitive.token) : true;
      const door = allow ? (a.doorCode||'') : 'â€¢â€¢â€¢â€¢ (masquÃ©)';
      const rules = g.rules?.fr?.items || [];
      const dep = g.departure?.fr || {};
      const ess = g.essentials?.fr || {};
      const ams = g.amenities || [];

      return html`
        <div class="grid" style="gap:18px">
          <div class="hero"><img alt="${g.name||''}" src="${g.cover?.imageUrl||''}"></div>

          <div class="grid grid-3">
            <div class="tile"><div class="k">Adresse</div><div><strong>${g.address||''}</strong></div></div>
            <div class="tile"><div class="k">Wiâ€‘Fi</div><div><strong>${(a.wifi?.ssid||'')}${a.wifi?.password? ' â€¢ '+a.wifi.password: ''}</strong></div></div>
            <div class="tile"><div class="k">Code porte</div><div><strong>${door}</strong></div></div>
          </div>

          <div class="grid grid-2">
            <div class="card"><h2>ArrivÃ©e & Checkâ€‘in</h2><div class="content">
              <div><span class="muted">Ã€ partir de</span> <strong>${a.checkin_from||''}</strong></div>
              ${a.parking? `<div><span class="muted">Parking</span> <strong>${a.parking}</strong></div>`:''}
              ${(a.notes||[]).length? `<ul>${(a.notes||[]).map(n=>`<li>${n}</li>`).join('')}</ul>`:''}
            </div></div>

            <div class="card"><h2>RÃ¨gles</h2><div class="content"><ul>${rules.map(r=>`<li>${r}</li>`).join('')}</ul></div></div>

            <div class="card"><h2>DÃ©part & Checkâ€‘out</h2><div class="content">
              ${dep.checkout_until? `<div><span class="muted">Avant</span> <strong>${dep.checkout_until}</strong></div>`:''}
              ${(dep.steps||[]).length? `<ul>${dep.steps.map(s=>`<li>${s.label}</li>`).join('')}</ul>`:''}
            </div></div>

            <div class="card"><h2>Infos utiles</h2><div class="content">
              ${ess.electricity? `<div><span class="muted">Ã‰lectricitÃ©</span> ${ess.electricity}</div>`:''}
              ${ess.water? `<div><span class="muted">Eau</span> ${ess.water}</div>`:''}
              ${(ess.emergency||[]).map(c=>`<div><span class="muted">${c.label}</span> ${c.href? `<a href="${c.href}">${c.value}</a>`: c.value}</div>`).join('')}
            </div></div>

            ${ams.length? `<div class="card" style="grid-column:1/-1"><h2>Ã‰quipements</h2><div class="content">${ams.map(a=>`<span class="pill">${a.label||''}</span>`).join('')}</div></div>`:''}
          </div>

          ${g.coords? html`<div class="card"><h2>Plan & accÃ¨s</h2><div class="content">
            <iframe title="map" style="width:100%;height:340px;border:1px solid var(--line);border-radius:12px" loading="lazy" referrerpolicy="no-referrer-when-downgrade"
              src="https://www.google.com/maps?q=${g.coords.lat},${g.coords.lng}&hl=fr&z=15&output=embed"></iframe>
          </div></div>`:''}

          ${g.brand?.supportPhone || g.brand?.supportWhatsApp || g.brand?.supportEmail ? html`<div class="card"><h2>Assistance</h2><div class="content actions">
            ${g.brand?.supportPhone? `<a class="btn" href="tel:${g.brand.supportPhone}">Appeler</a>`:''}
            ${g.brand?.supportWhatsApp? `<a class="btn" target="_blank" rel="noreferrer" href="${g.brand.supportWhatsApp}">WhatsApp 24/7</a>`:''}
            ${g.brand?.supportEmail? `<a class="btn" href="mailto:${g.brand.supportEmail}">Email</a>`:''}
            <button class="btn" onclick="window.print()">TÃ©lÃ©charger en PDF</button>
          </div></div>`:''}

          ${g.__sensitive?.token && token !== g.__sensitive.token ? `<div class="warn">Certaines informations sensibles sont masquÃ©es. Ajoutez votre jeton Ã  lâ€™URL : <code>?token=VOTRE_TOKEN</code></div>`:''}
        </div>`;
    }

    async function boot(){
      if(!slug){
        root.innerHTML = '<div class="warn">Slug manquant. Utilisez /guide/<em>votre-slug</em></div>';
        return;
      }
      const jsonUrl = `${SUPABASE_URL}/storage/v1/object/public/${GUIDES_BUCKET}/${encodeURIComponent(slug)}.json`;
      try{
        const r = await fetch(jsonUrl, { cache:'no-store' });
        if(!r.ok){
          if(r.status === 404){
            root.innerHTML = `<div class="warn">Guide introuvable pour <b>${slug}</b>.<br>VÃ©rifiez que <code>${jsonUrl}</code> existe dans le bucket <b>${GUIDES_BUCKET}</b>.</div>`;
            return;
          }
          throw new Error(`HTTP ${r.status}`);
        }
        const g = await r.json();
        const title = g?.name || `Guide ${slug}`;
        document.title = `${title} â€“ Conciergerie Zenata`;
        root.innerHTML = html`
          <div class="header" style="padding:0 0 10px 0;">
            <div>
              <div class="badge">Guide</div>
              <h1 style="margin:.2rem 0 0 .0;font-size:28px">${title}</h1>
            </div>
          </div>
          ${section(g)}
        `;
      }catch(e){
        root.innerHTML = `<div class="warn">Erreur de chargement: ${e.message||e}</div>`;
      }
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html> -->
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Guide Voyageur â€“ Conciergerie Zenata</title>
<link rel="icon" href="/logo/logo_officiel_couleur_picto.png"/>
<meta name="robots" content="noindex,nofollow"/>

<style>
:root{
  --bg1:#0d0e11; --bg2:#1a1b1f; --ink:#f5f5f5; --muted:#a3a3a3;
  --accent:#c7a059; --card:rgba(255,255,255,.05); --border:rgba(255,255,255,.10);
  --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,system-ui,sans-serif;color:var(--ink);
  background:radial-gradient(1000px 700px at 20% -10%, var(--bg2), var(--bg1) 80%);
  min-height:100vh; padding:28px;
}
.wrap{max-width:1200px;margin:0 auto}
.header{display:flex;align-items:center;gap:12px;margin-bottom:24px}
.header img{height:34px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4))}
.header .spacer{flex:1}
.header .btn{margin-left:6px}

.lang-toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.lang-toggle button{background:transparent;color:#ddd;border:0;padding:8px 12px;cursor:pointer}
.lang-toggle button.active{background:rgba(255,255,255,.1);color:#fff}

.hero{position:relative;overflow:hidden;border-radius:var(--radius);height:360px;margin-bottom:26px;border:1px solid var(--border);box-shadow:var(--shadow);display:none}
.hero img{width:100%;height:100%;object-fit:cover;filter:brightness(.85)}
.hero .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0) 50%,rgba(0,0,0,.65) 100%)}
.hero .title{position:absolute;bottom:20px;left:24px;right:24px;color:#fff}
.hero .title .badge{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.25);color:#fff;font-size:12px;border-radius:999px;padding:4px 10px;display:inline-block;margin-bottom:8px}
.hero .title h1{margin:0;font-size:30px;font-weight:700;letter-spacing:.3px}

.intro-card{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); backdrop-filter:blur(10px);
  text-align:center; padding:28px 20px; margin-bottom:28px; display:none
}
.intro-card h2{font-size:20px;margin-bottom:8px;color:var(--accent)}
.intro-card p{color:var(--muted);max-width:840px;margin:0 auto 6px;line-height:1.6}
.intro-card a{color:var(--accent);text-decoration:none}
.intro-card a:hover{text-decoration:underline}

.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));margin-bottom:32px}
.tile{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); backdrop-filter:blur(8px);
  padding:24px 18px; display:flex; flex-direction:column; align-items:center; justify-content:center;
  cursor:pointer; transition:all .2s ease; text-align:center; min-height:120px
}
.tile:hover{ transform:translateY(-3px); background:rgba(255,255,255,.08) }
.tile svg{ width:30px;height:30px;margin-bottom:10px;stroke:var(--accent);stroke-width:1.7 }
.tile span{ font-size:14px; font-weight:600; letter-spacing:.3px }

.footer{ text-align:center; color:var(--muted); margin-top:30px; font-size:13px }
.footer .btn{margin-top:10px}
.btn{ appearance:none; border:1px solid var(--border); background:rgba(255,255,255,.06); color:#eee; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; gap:8px }
.btn.primary{ background:linear-gradient(135deg,#0F172A,#1F2937); border:none }

/* Modale gÃ©nÃ©rique */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center; padding:20px; z-index:50 }
.modal[open]{ display:flex }
.modal-card{
  background:linear-gradient(180deg,#121317 0%,#0d0e11 100%);
  border:1px solid var(--border); border-radius:20px;
  max-width:820px; width:100%; box-shadow:var(--shadow); color:#f8f8f8
}
.modal-head{ display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); padding:14px 16px }
.modal-head strong{ font-size:17px }
.modal-close{ background:transparent; border:1px solid var(--border); border-radius:999px; color:#ccc; padding:6px 10px; cursor:pointer }
.modal-body{ padding:18px 16px 20px; font-size:15px; line-height:1.6 }
.modal-body .mapbox{ height:380px; border-radius:14px; overflow:hidden; border:1px solid var(--border); box-shadow:inset 0 0 0 1px rgba(255,255,255,.02); margin-bottom:10px }
.modal-actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap }

/* Chat IA minimal (fab + overlay simple) */
.ai-fab{position:fixed;right:18px;bottom:18px;z-index:60;width:56px;height:56px;border-radius:50%;
  border:1px solid rgba(255,255,255,.12); background:linear-gradient(135deg,#0F172A,#1F2937); color:#fff; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.ai-overlay{ position:fixed; inset:0; z-index:70; display:none; place-items:center; background:rgba(0,0,0,.6) }
.ai-overlay[open]{ display:grid }
.ai-card{ width:min(780px,92vw); max-height:min(82vh,820px); display:flex; flex-direction:column; overflow:hidden;
  border-radius:18px; border:1px solid rgba(255,255,255,.12); background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)); box-shadow:0 30px 80px rgba(0,0,0,.55); color:#f5f5f5 }
.ai-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12)}
.ai-stream{flex:1;min-height:160px;max-height:56vh;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:10px}
.ai-msg{padding:10px 12px;border:1px solid rgba(255,255,255,.1);border-radius:12px;max-width:80%}
.ai-msg.user{align-self:flex-end;background:rgba(255,255,255,.10)}
.ai-msg.bot{align-self:flex-start;background:rgba(255,255,255,.06)}
.ai-form{display:flex;gap:8px;border-top:1px dashed rgba(255,255,255,.12);padding:10px}
.ai-form input{flex:1;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;background:rgba(255,255,255,.06);color:#fff}
.ai-send{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.08);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}

.error-box{
  background:rgba(255,0,0,.08); border:1px solid rgba(255,0,0,.25); color:#ffdddd;
  padding:14px; border-radius:12px; margin:10px 0; white-space:pre-wrap; font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px
}

/* print */
@media print{
  body{ background:#fff; color:#000; padding:0 }
  .header, .lang-toggle, .modal, .btn, .ai-fab, .ai-overlay{ display:none !important }
  .hero{ height:260px; border:none; box-shadow:none; display:block }
  .tile, .intro-card{ box-shadow:none }
  a{ color:#000; text-decoration:none }
}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <img src="/logo/logo_officiel_couleur_picto.png" alt="Zenata">
    <strong>Conciergerie Zenata</strong>
    <div class="spacer"></div>

    <div class="lang-toggle" id="langToggle">
      <button data-lang="fr" class="active">FR</button>
      <button data-lang="en">EN</button>
    </div>

    <a class="btn" id="btn-wa" target="_blank" rel="noreferrer">WhatsApp</a>
    <a class="btn" id="btn-call" href="tel:+212600000000">Appeler</a>
    <button class="btn" onclick="window.print()">PDF</button>
  </div>

  <div id="hero" class="hero">
    <img id="hero-img" alt="">
    <div class="overlay"></div>
    <div class="title"><div class="badge">Guide voyageur</div><h1 id="title"></h1></div>
  </div>

  <div id="intro-card" class="intro-card">
    <h2 id="welcome-title">Bienvenue Ã  Zenata ðŸŒ´</h2>
    <p id="intro-text"></p>
    <p><b>Email :</b> <a href="mailto:conciergeriezenata@gmail.com">conciergeriezenata@gmail.com</a></p>
  </div>

  <div id="alert" class="error-box" style="display:none"></div>

  <div id="grid" class="grid"></div>

  <div class="footer">
    Â© <span id="year"></span> Conciergerie Zenata â€” <span id="footer-premium">SÃ©jour Premium</span>
  </div>
</div>

<!-- Modale gÃ©nÃ©rique -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <strong id="m-title">DÃ©tail</strong>
      <button class="modal-close" id="m-close">Fermer</button>
    </div>
    <div class="modal-body" id="m-body"></div>
  </div>
</div>

<!-- Chat IA -->
<button id="ai-fab" class="ai-fab" type="button" title="Concierge IA">ðŸ’¬</button>
<div id="ai-overlay" class="ai-overlay" aria-hidden="true">
  <div class="ai-card" role="dialog" aria-modal="true" aria-labelledby="ai-title">
    <div class="ai-head">
      <strong id="ai-title">Concierge IA</strong>
      <button id="ai-close" class="btn" type="button">âœ•</button>
    </div>
    <div id="ai-stream" class="ai-stream"></div>
    <form id="ai-form" class="ai-form" novalidate>
      <input id="ai-input" placeholder="Posez votre questionâ€¦" autocomplete="off"/>
      <button class="ai-send" type="submit" aria-label="Envoyer">â†©ï¸Ž</button>
    </form>
  </div>
</div>

<script>
(() => {
  /* ===== CONFIG FALLBACK ===== */
  const SUPABASE_URL = "https://ojgchrqtvkwzhjvwwftd.supabase.co"; // <- mets le tien si besoin
  const GUIDES_BUCKET = "guides";

  /* ===== UI utils ===== */
  const $ = (id)=>document.getElementById(id);
  $("year").textContent = new Date().getFullYear();

  function showAlert(msg){
    const box = $("alert");
    if(!box) return;
    box.style.display = "block";
    box.textContent = String(msg || "Erreur inconnue");
  }

  function openModal(title, html){
    $("m-title").textContent = title || "DÃ©tail";
    $("m-body").innerHTML = html || "";
    $("modal").setAttribute("open","");
    $("modal").setAttribute("aria-hidden","false");
  }
  function closeModal(){
    $("modal").removeAttribute("open");
    $("modal").setAttribute("aria-hidden","true");
  }
  $("m-close").addEventListener("click", (e)=>{ e.preventDefault(); closeModal(); });
  $("modal").addEventListener("click", (e)=>{ if (e.target.id === "modal") closeModal(); });

  function icon(name){
    const icons={
      wifi:`<svg fill="none" viewBox="0 0 24 24"><path d="M5 12a9 9 0 0114 0M2 9a12 12 0 0120 0M8.5 15.5a5 5 0 017 0M12 20h.01"/></svg>`,
      door:`<svg fill="none" viewBox="0 0 24 24"><path d="M14 12v.01M6 3h12v18H6z"/></svg>`,
      checkin:`<svg fill="none" viewBox="0 0 24 24"><path d="M3 3h18v18H3zM8 12l2 2 5-5"/></svg>`,
      map:`<svg fill="none" viewBox="0 0 24 24"><path d="M9 3l6 3 6-3v18l-6 3-6-3-6 3V3l6-3z"/></svg>`,
      rules:`<svg fill="none" viewBox="0 0 24 24"><path d="M5 5h14M5 9h14M5 13h9M5 17h9"/></svg>`,
      amenities:`<svg fill="none" viewBox="0 0 24 24"><path d="M4 6h16v12H4z"/></svg>`,
      help:`<svg fill="none" viewBox="0 0 24 24"><path d="M9 9a3 3 0 116 0c0 1.657-3 3-3 3m0 4h.01"/></svg>`,
      exit:`<svg fill="none" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4m7 4l5 5-5 5m5-5H9"/></svg>`,
      location:`<svg fill="none" viewBox="0 0 24 24"><path d="M12 21s7-4.35 7-10a7 7 0 10-14 0c0 5.65 7 10 7 10zM12 11a2 2 0 110-4 2 2 0 010 4z"/></svg>`
    };
    return icons[name] || icons.map;
  }

  function br(s){ return (s||"").replace(/\n/g,"<br>"); }
  function pick(obj, lang){
    if(!obj) return null;
    return obj[lang] ?? obj['fr'] ?? obj['en'] ?? null;
  }

  /* ===== LOAD GUIDE (with robust fallbacks) ===== */
  async function fetchGuide(slug){
    const ts = Date.now();
    // 1) Try Netlify function (no-cache)
    try{
      const r = await fetch(`/.netlify/functions/get-guide?slug=${encodeURIComponent(slug)}&ts=${ts}`, { cache:'no-store' });
      if(r.ok){
        return await r.json();
      }else{
        console.warn('get-guide failed:', r.status, await r.text().catch(()=>'')); // continue to fallback
      }
    }catch(err){
      console.warn('get-guide error:', err);
    }
    // 2) Fallback to Supabase public
    try{
      const url = `${SUPABASE_URL}/storage/v1/object/public/${GUIDES_BUCKET}/${encodeURIComponent(slug)}.json?ts=${ts}`;
      const r = await fetch(url, { cache:'no-store' });
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }catch(err2){
      throw new Error(`Impossible de charger le guide (${slug}).`);
    }
  }

  /* ===== RENDER ===== */
  async function boot(){
    const slug=(location.pathname.split('/').pop()||'').replace(/\.html$/,'');
    const qs=new URLSearchParams(location.search);
    const token=qs.get('token')||'';
    const langParam=(qs.get('lang')||'').toLowerCase();
    let LANG = (langParam==='en') ? 'en' : 'fr';

    // Toggle langue
    const langToggle = $("langToggle");
    langToggle.querySelectorAll('button').forEach(b=>{
      b.onclick = ()=>{
        const l=b.getAttribute('data-lang');
        const url = new URL(location.href); url.searchParams.set('lang', l);
        location.href = url.toString();
      };
      b.classList.toggle('active', b.dataset.lang===LANG);
    });

    // WhatsApp header
    const waMsg = encodeURIComponent(`Bonjour ðŸ‘‹ (guide ${slug})`);
    $("btn-wa").href = `https://wa.me/212600000000?text=${waMsg}`;

    let g;
    try{
      g = await fetchGuide(slug);
    }catch(err){
      showAlert(err.message||err);
      // Montre quand mÃªme un shell minimal (pas de page blanche)
      $("title").textContent = "Guide introuvable";
      $("intro-text").textContent = "Le guide n'a pas pu Ãªtre chargÃ©.";
      $("intro-card").style.display = '';
      return;
    }

    // Hero
    if(g.cover?.imageUrl){ $("hero-img").src=g.cover.imageUrl; $("hero").style.display=''; }
    $("title").textContent=g.name||'';

    // Intro
    const intro = pick(g.intro, LANG) || pick(g.welcome, LANG) || (LANG==='en'
      ? 'Weâ€™re delighted to host you in Zenata. Enjoy your stay.'
      : 'Nous sommes ravis de vous accueillir Ã  Zenata. Profitez de votre sÃ©jour.');
    $("intro-text").innerHTML = br(intro);
    $("intro-card").style.display='';

    const allow = g.__sensitive?.token ? (token===g.__sensitive.token) : true;
    const a = pick(g.arrival, LANG) || {};
    const dep = pick(g.departure, LANG) || {};
    const rules = (pick(g.rules, LANG)?.items) || [];
    const ams = g.amenities || [];

    const grid = $("grid");
    grid.innerHTML = ""; // reset

    const cards = [
      { key: (LANG==='en'?'Address':'Adresse'), icon:'map', onClick:()=> openModal((LANG==='en'?'Address':'Adresse'), `<p>${g.address||''}</p>`) },
      { key: 'Wi-Fi', icon:'wifi', onClick:()=> openModal('Wi-Fi', `<p><b>SSID</b> : ${a.wifi?.ssid||''}<br><b>${LANG==='en'?'Password':'Mot de passe'}</b> : ${a.wifi?.password||''}</p>`) },
      { key: (LANG==='en'?'Door code':'Code porte'), icon:'door', onClick:()=> openModal((LANG==='en'?'Door code':'Code porte'),
        allow ? `<p style="font-size:28px"><b>${a.doorCode||''}</b></p>` : `<p>${LANG==='en'?'Sensitive info hidden. Add your token.':'Infos sensibles masquÃ©es. Ajoutez votre jeton.'}</p>`) },
      { key: (LANG==='en'?'Check-in':'Check-in'), icon:'checkin', onClick:()=> openModal((LANG==='en'?'Arrival & Check-in':'ArrivÃ©e & Check-in'),
        `<p>${LANG==='en'?'From':'Ã€ partir de'} <b>${a.checkin_from||''}</b></p>`+
        `${a.parking?`<p><b>${LANG==='en'?'Parking':'Parking'} :</b> ${a.parking}</p>`:''}`+
        `${(a.notes||[]).length?`<ul>${a.notes.map(n=>`<li>${n}</li>`).join('')}</ul>`:''}`) },
      { key: (LANG==='en'?'House rules':'RÃ¨gles'), icon:'rules', onClick:()=> openModal((LANG==='en'?'House rules':'RÃ¨gles'),
        rules.length?`<ul>${rules.map(r=>`<li>${r}</li>`).join('')}</ul>`:`<p>${LANG==='en'?'No rules.':'Aucune rÃ¨gle.'}</p>`) },
      { key: (LANG==='en'?'Amenities':'Ã‰quipements'), icon:'amenities', onClick:()=> openModal((LANG==='en'?'Amenities':'Ã‰quipements'),
        ams.length? ams.map(x=>`<span style="display:inline-block;margin:4px 6px 0 0;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;">${x.label}</span>`).join('')
        : `<p>${LANG==='en'?'Not provided.':'Non renseignÃ©.'}</p>`) },
      { key: (LANG==='en'?'Essentials':'Essentiels'), icon:'map', onClick:()=> openModal((LANG==='en'?'Essentials':'Essentiels'), `<p>${br(pick(g.essentials, LANG) || '')}</p>`) },
      { key: (LANG==='en'?'Checkout':'DÃ©part'), icon:'exit', onClick:()=> openModal((LANG==='en'?'Checkout':'DÃ©part'),
        `<p>${LANG==='en'?'Check-out before':'Check-out avant'} <b>${(dep.checkout_until||'11:00')}</b></p>`) },
      { key: (LANG==='en'?'Support':'Assistance'), icon:'help', onClick:()=> openModal((LANG==='en'?'Support':'Assistance & Contact'),
        `<p><b>Email :</b> <a href="mailto:conciergeriezenata@gmail.com">conciergeriezenata@gmail.com</a></p>
         <div class="modal-actions">
           <a class="btn primary" target="_blank" rel="noreferrer" href="https://wa.me/212600000000?text=${encodeURIComponent(LANG==='en'?'Hello':'Bonjour')}">WhatsApp</a>
           <a class="btn" href="tel:+212600000000">${LANG==='en'?'Call':'Appeler'}</a>
         </div>`) }
    ];

    // Localisation (fallback iframe)
    const lat = g?.geo?.lat!=null ? parseFloat(g.geo.lat) : NaN;
    const lng = g?.geo?.lng!=null ? parseFloat(g.geo.lng) : NaN;
    const hasGeo = !Number.isNaN(lat) && !Number.isNaN(lng);
    if (hasGeo){
      cards.unshift({
        key: (LANG==='en'?'Location':'Localisation'), icon:'location',
        onClick: ()=> openModal((LANG==='en'?'Location':'Localisation'),
          `<div class="mapbox">
             <iframe src="https://www.google.com/maps?q=${lat},${lng}&z=15&output=embed"
                     width="100%" height="100%" style="border:0" loading="lazy"></iframe>
           </div>
           <div class="modal-actions">
             <a class="btn primary" target="_blank" rel="noreferrer"
                href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}">${LANG==='en'?'Open in Google Maps':'Ouvrir dans Google Maps'}</a>
             <a class="btn" target="_blank" rel="noreferrer"
                href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}">${LANG==='en'?'Directions':'ItinÃ©raire'}</a>
           </div>`
        )
      });
    }

    // Render tiles
    for(const c of cards){
      const d=document.createElement('div');
      d.className='tile';
      d.innerHTML=`${icon(c.icon)}<span>${c.key}</span>`;
      d.onclick=c.onClick;
      grid.appendChild(d);
    }
  }

  /* ===== Chat IA minimal ===== */
  function initAi(){
    const fab = $("ai-fab");
    const overlay = $("ai-overlay");
    const closeBtn = $("ai-close");
    const form = $("ai-form");
    const input = $("ai-input");
    const stream = $("ai-stream");

    function open(){ overlay.setAttribute('open',''); overlay.setAttribute('aria-hidden','false'); input?.focus(); }
    function close(){ overlay.removeAttribute('open'); overlay.setAttribute('aria-hidden','true'); }
    fab?.addEventListener('click', (e)=>{ e.preventDefault(); open(); });
    closeBtn?.addEventListener('click', (e)=>{ e.preventDefault(); close(); });
    overlay?.addEventListener('click', (e)=>{ if(e.target===overlay) close(); });

    function push(role, html){
      const div=document.createElement('div');
      div.className='ai-msg ' + (role==='user'?'user':'bot');
      div.innerHTML = (html||'').replace(/\n/g,'<br>');
      stream.appendChild(div);
      stream.scrollTop = stream.scrollHeight;
    }

    async function ask(q){
      if(!q.trim()) return;
      push('user', q); input.value='';
      const thinking=document.createElement('div'); thinking.className='ai-msg bot'; thinking.textContent='â€¦';
      stream.appendChild(thinking); stream.scrollTop = stream.scrollHeight;
      try{
        const qs = new URLSearchParams(location.search);
        const slug=(location.pathname.split('/').pop()||'').replace(/\.html$/,'');
        const token=qs.get('token')||''; const lang=(qs.get('lang')||'fr');
        const r = await fetch('/.netlify/functions/guide-chat',{ method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ slug, token, lang, question:q })
        });
        const data = await r.json().catch(()=>({}));
        thinking.remove();
        if(!r.ok) throw new Error(data.error||('HTTP '+r.status));
        push('bot', data.answer || '(aucune rÃ©ponse)');
      }catch(e){
        thinking.remove(); push('bot', 'Erreur : '+(e.message||e));
      }
    }

    form?.addEventListener('submit', (e)=>{ e.preventDefault(); e.stopPropagation(); ask(input.value||''); });
  }

  document.addEventListener('DOMContentLoaded', () => { boot(); initAi(); });
})();
</script>
</body>
</html>
