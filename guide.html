<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Guide Voyageur â€“ Conciergerie Zenata</title>
<link rel="icon" href="/logo/logo_officiel_couleur_picto.png"/>
<meta name="robots" content="noindex,nofollow"/>

<style>
:root{
  --bg1:#0d0e11; --bg2:#1a1b1f;
  --ink:#f5f5f5; --muted:#a3a3a3;
  --accent:#c7a059;
  --card:rgba(255,255,255,.05);
  --border:rgba(255,255,255,.10);
  --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,system-ui,sans-serif;color:var(--ink);
  background:
    radial-gradient(1400px 900px at 15% -10%, #20232b 0%, transparent 60%),
    radial-gradient(1100px 700px at 100% 0%, rgba(199,160,89,.10), transparent 50%),
    linear-gradient(180deg, var(--bg2), var(--bg1) 60%);
  min-height:100vh; padding:28px;
}
.wrap{max-width:1200px;margin:0 auto}
.header{display:flex;align-items:center;gap:12px;margin-bottom:24px}
.header img{height:34px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4))}
.header .spacer{flex:1}
.header .btn{margin-left:6px}

/* langue */
.lang-toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.lang-toggle button{background:transparent;color:#ddd;border:0;padding:8px 12px;cursor:pointer}
.lang-toggle button.active{background:rgba(255,255,255,.1);color:#fff}

/* hero */
.hero{position:relative;overflow:hidden;border-radius:var(--radius);height:400px;margin-bottom:30px;border:1px solid var(--border);box-shadow:var(--shadow);display:none}
.hero img{width:100%;height:100%;object-fit:cover;filter:brightness(.85)}
.hero .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0) 55%,rgba(0,0,0,.65) 100%)}
.hero .title{position:absolute;bottom:24px;left:28px;right:28px;color:#fff}
.hero .title .badge{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.25);color:#fff;font-size:12px;border-radius:999px;padding:4px 10px;display:inline-block;margin-bottom:8px}
.hero .title h1{margin:0;font-size:34px;font-weight:700;letter-spacing:.3px}

/* intro */
.intro-card{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); backdrop-filter:blur(12px);
  text-align:center; padding:36px 24px; margin-bottom:36px; display:none
}
.intro-card h2{font-size:22px;margin-bottom:10px;color:var(--accent)}
.intro-card p{color:var(--muted);max-width:860px;margin:0 auto 8px;line-height:1.65}
.intro-card a{color:var(--accent);text-decoration:none}
.intro-card a:hover{text-decoration:underline}

/* grid */
.grid{
  display:grid; gap:18px;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  margin-bottom:42px;
}
.tile{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); backdrop-filter:blur(10px);
  padding:28px 20px; display:flex; flex-direction:column; align-items:center; justify-content:center;
  cursor:pointer; transition:all .25s ease; text-align:center; min-height:132px
}
.tile:hover{ transform:translateY(-3px); background:rgba(255,255,255,.08) }
.tile svg{ width:34px;height:34px;margin-bottom:12px;stroke:var(--accent);stroke-width:1.7 }
.tile span{ font-size:15px; font-weight:600; letter-spacing:.3px }

/* modale gÃ©nÃ©rique */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center; padding:24px; z-index:50 }
.modal[open]{ display:flex }
.modal-card{
  background:linear-gradient(180deg,#121317 0%,#0d0e11 100%);
  border:1px solid var(--border); border-radius:20px;
  max-width:880px; width:100%; box-shadow:var(--shadow); color:#f8f8f8
}
.modal-head{ display:flex; align-items:center; gap:10px; justify-content:space-between; border-bottom:1px solid var(--border); padding:16px 20px }
.modal-head strong{ font-size:18px }
.modal-close{ background:transparent; border:1px solid var(--border); border-radius:999px; color:#ccc; padding:6px 12px; cursor:pointer }
.modal-body{ padding:22px 20px 24px; font-size:15px; line-height:1.6 }
.modal-body .mapbox{ height:420px; border-radius:14px; overflow:hidden; border:1px solid var(--border); box-shadow:inset 0 0 0 1px rgba(255,255,255,.02); margin-bottom:12px }
.modal-actions{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap }
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);
      border-radius:999px;text-decoration:none;font-size:12px;color:#fff;background:rgba(255,255,255,.06)}
.pill:hover{background:rgba(255,255,255,.12)}
.k{font-size:12px;color:#bbb;margin-top:6px}
.list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
.list-row{display:flex;gap:10px;align-items:flex-start}
.dot{width:8px;height:8px;border-radius:999px;background:#C7A059;position:relative;top:8px;flex-shrink:0}
.list-col{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.list-txt{font-size:14px;line-height:1.45}

.btn{ appearance:none; border:1px solid var(--border); background:rgba(255,255,255,.06); color:#eee; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; gap:8px }
.btn.primary{ background:linear-gradient(135deg,#0F172A,#1F2937); border:none }

/* chatbot IA */
.ai-fab{position:fixed;right:18px;bottom:18px;z-index:60;width:56px;height:56px;border-radius:50%;
  border:1px solid rgba(255,255,255,.12); background:linear-gradient(135deg,#0F172A,#1F2937); color:#fff; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,.35)}
.ai-overlay{ position:fixed; inset:0; z-index:70; display:none; place-items:center; background:radial-gradient(70% 100% at 50% 50%, rgba(0,0,0,.55), rgba(0,0,0,.75)); backdrop-filter: blur(6px) }
.ai-overlay[open]{ display:grid }
.ai-card{ width:min(880px,92vw); max-height:min(82vh,820px); display:flex; flex-direction:column; overflow:hidden;
  border-radius:20px; border:1px solid rgba(255,255,255,.12);
  background:
    radial-gradient(120% 160% at -10% -20%, rgba(199,160,89,.10), transparent 40%),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow: 0 30px 80px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.04);
  color: #f5f5f5;
}
.ai-head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.12)}
.ai-stream{flex:1;min-height:180px;max-height:56vh;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:10px}
.ai-msg{padding:10px 12px;border:1px solid rgba(255,255,255,.1);border-radius:12px;max-width:80%}
.ai-msg.user{align-self:flex-end;background:rgba(255,255,255,.10)}
.ai-msg.bot{align-self:flex-start;background:rgba(255,255,255,.06)}
.ai-suggest{display:flex;gap:8px;flex-wrap:wrap;padding:0 10px}
.ai-chip{border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
.ai-form{display:flex;gap:8px;border-top:1px dashed rgba(255,255,255,.12);padding:10px}
.ai-form input{flex:1;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;background:rgba(255,255,255,.06);color:#fff}
.ai-send{border:1px solid rgba(255,255,255,.12);background:linear-gradient(135deg,#0F172A,#1F2937);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}

/* erreurs visibles */
.error-box{background:rgba(255,0,0,.08);border:1px solid rgba(255,255,255,.25);color:#ffdddd;padding:14px;border-radius:12px;margin:10px 0;white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}

/* footer/print */
.footer{ text-align:center; color:#b9b9b9; margin-top:40px; font-size:13px }
.footer .btn{margin-top:10px}
@media print{
  body{ background:#fff; color:#000; padding:0 }
  .header, .lang-toggle, .modal, .btn, .ai-fab, .ai-overlay{ display:none !important }
  .hero{ height:300px; border:none; box-shadow:none; display:block }
  .tile, .intro-card{ box-shadow:none }
  a{ color:#000; text-decoration:none }
}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <img src="/logo/logo_officiel_couleur_picto.png" alt="Zenata">
    <strong>Conciergerie Zenata</strong>
    <div class="spacer"></div>

    <!-- FR/EN -->
    <div class="lang-toggle" id="langToggle">
      <button data-lang="fr" class="active">FR</button>
      <button data-lang="en">EN</button>
    </div>

    <!-- Actions -->
    <a class="btn" id="btn-wa" target="_blank" rel="noreferrer">WhatsApp</a>
    <a class="btn" id="btn-call" href="tel:+212600000000" data-i18n="call">Appeler</a>
    <button class="btn" onclick="window.print()" data-i18n="pdf">PDF</button>
  </div>

  <!-- HERO -->
  <div id="hero" class="hero">
    <img id="hero-img" alt="">
    <div class="overlay"></div>
    <div class="title">
      <div class="badge" data-i18n="traveler_guide">Guide voyageur</div>
      <h1 id="title"></h1>
    </div>
  </div>

  <!-- INTRO -->
  <div id="intro-card" class="intro-card">
    <h2 id="welcome-title">Bienvenue Ã  Zenata ðŸŒ´</h2>
    <p id="intro-text"></p>
    <p><b>Email :</b> <a href="mailto:conciergeriezenata@gmail.com">conciergeriezenata@gmail.com</a></p>
  </div>

  <div id="alert" class="error-box" style="display:none"></div>

  <div id="grid" class="grid"></div>

  <div class="footer">
    Â© <span id="year"></span> Conciergerie Zenata â€” <span id="footer-premium">SÃ©jour Premium</span>
  </div>
</div>

<!-- Modale gÃ©nÃ©rique -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <strong id="m-title">DÃ©tail</strong>
      <button class="modal-close" id="m-close" data-i18n="close">Fermer</button>
    </div>
    <div class="modal-body" id="m-body"></div>
  </div>
</div>

<!-- FAB Chat IA -->
<button id="ai-fab" class="ai-fab" type="button" title="Concierge IA">ðŸ’¬</button>
<!-- Modale Chat IA -->
<div id="ai-overlay" class="ai-overlay" aria-hidden="true">
  <div class="ai-card" role="dialog" aria-modal="true" aria-labelledby="ai-title">
    <div class="ai-head">
      <div style="display:flex;align-items:center;gap:10px">
        <img src="/logo/logo_officiel_couleur_picto.png" alt="" style="width:26px;height:26px;border-radius:8px;border:1px solid rgba(255,255,255,.12)"/>
        <strong id="ai-title">Concierge IA</strong>
      </div>
      <button id="ai-close" class="btn" type="button">âœ•</button>
    </div>
    <div id="ai-stream" class="ai-stream"></div>
    <div class="ai-suggest">
      <button class="ai-chip" type="button" data-q="Heure de check-in ?">Check-in</button>
      <button class="ai-chip" type="button" data-q="Mot de passe Wi-Fi ?">Wi-Fi</button>
      <button class="ai-chip" type="button" data-q="Bons restos Ã  proximitÃ© ?">Restos</button>
    </div>
    <form id="ai-form" class="ai-form" novalidate>
      <input id="ai-input" placeholder="Posez votre questionâ€¦" autocomplete="off"/>
      <button class="ai-send" type="submit" aria-label="Envoyer">â†©ï¸Ž</button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {
  /* ====== CONFIG ====== */
  const SUPABASE_URL = "https://ojgchrqtvkwzhjvwwftd.supabase.co";
  const GUIDES_BUCKET = "guides";
  // âš ï¸ remplace par ta clÃ© anonyme si besoin
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9qZ2NocnF0dmt3emhqdnd3ZnRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2OTMxODEsImV4cCI6MjA3NTI2OTE4MX0.Ok7fj3QUs28Q8dOiNy6caSBmjcUmjFrZgmIvAnzJZ00";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const $ = (id)=>document.getElementById(id);
  $("year").textContent = new Date().getFullYear();

  /* ====== i18n ====== */
  let LANG='fr';
  const UI = {
    fr:{traveler_guide:"Guide voyageur",call:"Appeler",pdf:"PDF",download_pdf:"TÃ©lÃ©charger en PDF",welcome_title:"Bienvenue Ã  Zenata ðŸŒ´",welcome_fallback:"Nous sommes ravis de vous accueillir Ã  Zenata. Profitez de votre sÃ©jour.",location:"Localisation",open_gmaps:"Ouvrir dans Google Maps",directions:"ItinÃ©raire",explore_nearby:"Explorer autour",neighborhood:"Quartier",do_see:"Ã€ faire / Recos",link:"Lien",view:"Voir",address:"Adresse",wifi:"Wi-Fi",door_code:"Code porte",sensitive_hidden:"Infos sensibles masquÃ©es. Ajoutez votre jeton",checkin:"ArrivÃ©e & Check-in",from:"Ã€ partir de",parking:"Parking",house_rules:"RÃ¨gles",no_rules:"Aucune rÃ¨gle.",amenities:"Ã‰quipements",not_provided:"Non renseignÃ©.",essentials:"Essentiels",checkout:"DÃ©part",checkout_before:"Check-out avant",support:"Assistance & Contact",email:"Email",whatsapp:"WhatsApp",report_issue:"Signaler un souci",help_issues:"DÃ©pannage",report_thanks:"Merci, câ€™est envoyÃ©.",report_error:"Erreur",network_error:"Erreur rÃ©seau",appliances:"Appareils & Mode dâ€™emploi",no_data:"Non renseignÃ©.",parking_access:"Parking & AccÃ¨s",spot:"Emplacement",extras:"Services additionnels",book_extra:"RÃ©server un extra :",detail:"DÃ©tail"},
    en:{traveler_guide:"Traveler Guide",call:"Call",pdf:"PDF",download_pdf:"Download PDF",welcome_title:"Welcome to Zenata ðŸŒ´",welcome_fallback:"Weâ€™re delighted to host you in Zenata. Enjoy your stay.",location:"Location",open_gmaps:"Open in Google Maps",directions:"Directions",explore_nearby:"Explore nearby",neighborhood:"Neighborhood",do_see:"Do & See",link:"Link",view:"View",address:"Address",wifi:"Wi-Fi",door_code:"Door code",sensitive_hidden:"Sensitive info hidden. Add your token",checkin:"Arrival & Check-in",from:"From",parking:"Parking",house_rules:"House rules",no_rules:"No rules.",amenities:"Amenities",not_provided:"Not provided.",essentials:"Essentials",checkout:"Checkout",checkout_before:"Check-out before",support:"Support",email:"Email",whatsapp:"WhatsApp",report_issue:"Report an issue",help_issues:"Help & Issues",report_thanks:"Thanks, received.",report_error:"Error",network_error:"Network error",appliances:"Appliances",no_data:"No data.",parking_access:"Parking & Access",spot:"Spot",extras:"Extras",book_extra:"Book an extra:",detail:"Detail"}
  };
  const S = (k)=> (UI[LANG] && UI[LANG][k]) || UI['fr'][k] || k;
  const br = s => String(s||'').replace(/\n/g,'<br>');

  function showAlert(msg){ const box = $("alert"); if(!box) return; box.style.display="block"; box.textContent=String(msg||"Erreur inconnue"); }
  function hideAlert(){ const box = $("alert"); if(box) box.style.display="none"; }

  /* ====== Helpers multi-langues ====== */
  function pickLang(v){
    if (v == null) return null;
    if (typeof v === 'string') return v;
    if (typeof v === 'object'){
      if (v[LANG] != null) return v[LANG];
      if (v.fr != null) return v.fr;
      if (v.en != null) return v.en;
    }
    return null;
  }
  function pickText(v){
    const t = pickLang(v);
    if (t == null) return null;
    const s = String(t).trim();
    return s === '' ? null : s;
  }
  function isHttpUrl(s){ return typeof s === 'string' && /^https?:\/\//i.test(s); }
  function resolveCoverCandidates(g){
    const cand = [];
    const c = g?.cover;
    const direct =
      (c && typeof c === 'object' && (c.imageUrl || c.url || c.src)) ||
      (typeof c === 'string' ? c : null);
    if (direct) cand.push(direct);
    if (typeof g?.coverPath === 'string') cand.push(g.coverPath);
    if (typeof g?.coverKey  === 'string') cand.push(g.coverKey);
    if (typeof g?.image     === 'string') cand.push(g.image);

    const expanded = [];
    const ts = Date.now();
    for (const v of cand){
      if (!v) continue;
      if (isHttpUrl(v)) { expanded.push(`${v}${v.includes('?') ? '' : `?ts=${ts}`}`); continue; }
      const maybeKey = v.replace(/^\/+/, '');
      expanded.push(`${SUPABASE_URL}/storage/v1/object/public/${GUIDES_BUCKET}/${encodeURIComponent(maybeKey)}?ts=${ts}`);
      expanded.push(`${SUPABASE_URL}/storage/v1/object/public/${maybeKey}?ts=${ts}`);
    }
    return [...new Set(expanded)];
  }
  function loadFirstWorkingImage(urls, imgEl, onOk, onFail){
    if (!urls || !urls.length) { onFail?.('Aucun candidat'); return; }
    let i = 0;
    const tryNext = () => {
      if (i >= urls.length) { onFail?.('Aucune URL valide'); return; }
      const url = urls[i++];
      const tmp = new Image();
      tmp.onload = () => { imgEl.src = url; onOk?.(url); };
      tmp.onerror = () => { tryNext(); };
      tmp.referrerPolicy = 'no-referrer';
      tmp.src = url;
    };
    tryNext();
  }

  function openModal(title, html){
    $("m-title").textContent = title || S('detail');
    $("m-body").innerHTML = html || "";
    $("modal").setAttribute("open",""); $("modal").setAttribute("aria-hidden","false");
  }
  function closeModal(){
    $("modal").removeAttribute("open"); $("modal").setAttribute("aria-hidden","true");
  }
  $("m-close").addEventListener("click",(e)=>{e.preventDefault();closeModal();});
  $("modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeModal(); });

  function icon(name){
    const icons={
      wifi:`<svg fill="none" viewBox="0 0 24 24"><path d="M5 12a9 9 0 0114 0M2 9a12 12 0 0120 0M8.5 15.5a5 5 0 017 0M12 20h.01"/></svg>`,
      door:`<svg fill="none" viewBox="0 0 24 24"><path d="M14 12v.01M6 3h12v18H6z"/></svg>`,
      checkin:`<svg fill="none" viewBox="0 0 24 24"><path d="M3 3h18v18H3zM8 12l2 2 5-5"/></svg>`,
      map:`<svg fill="none" viewBox="0 0 24 24"><path d="M9 3l6 3 6-3v18l-6 3-6-3-6 3V3l6-3z"/></svg>`,
      rules:`<svg fill="none" viewBox="0 0 24 24"><path d="M5 5h14M5 9h14M5 13h9M5 17h9"/></svg>`,
      amenities:`<svg fill="none" viewBox="0 0 24 24"><path d="M4 6h16v12H4z"/></svg>`,
      help:`<svg fill="none" viewBox="0 0 24 24"><path d="M9 9a3 3 0 116 0c0 1.657-3 3-3 3m0 4h.01"/></svg>`,
      exit:`<svg fill="none" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4m7 4l5 5-5 5m5-5H9"/></svg>`,
      location:`<svg fill="none" viewBox="0 0 24 24"><path d="M12 21s7-4.35 7-10a7 7 0 10-14 0c0 5.65 7 10 7 10zM12 11a2 2 0 110-4 2 2 0 010 4z"/></svg>`
    };
    return icons[name] || icons.map;
  }

  function parseLines(arr){
    return (arr||[]).map(line=>{
      const parts = String(line).split('|').map(s=>s.trim());
      const left = parts[0]||'';
      const url = parts[1] && /^https?:\/\//i.test(parts[1]) ? parts[1] : null;
      let lat=null,lng=null;
      if(parts[2] && /-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?/.test(parts[2])){
        const [a,b]=parts[2].split(',').map(x=>parseFloat(x.trim())); lat=a; lng=b;
      }
      let cat=null, text=left;
      const m = left.match(/^\[([^\]]+)\]\s*(.*)$/);
      if(m){ cat = m[1]; text = m[2]||''; }
      return { text, url, lat, lng, cat };
    });
  }
  function groupByCat(items){
    const map = new Map();
    items.forEach(it=>{
      const key = (it.cat|| (LANG==='en'?'Others':'Autres')).trim();
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(it);
    });
    return map;
  }

  async function fetchGuide(slug){
  const ts = Date.now();
  const bucketUrl = `${SUPABASE_URL}/storage/v1/object/public/${GUIDES_BUCKET}/${encodeURIComponent(slug)}.json?ts=${ts}`;

  // 1) Bucket d'abord (source de vÃ©ritÃ©)
  try {
    const r = await fetch(bucketUrl, { cache:'no-store' });
    if (r.ok) return await r.json();
  } catch (e) {
    console.warn('bucket fetch failed (will try lambda):', e);
  }

  // 2) Fallback: lambda (peut renvoyer un enregistrement DB)
  try {
    const r2 = await fetch(`/.netlify/functions/get-guide?slug=${encodeURIComponent(slug)}&ts=${ts}`, { cache:'no-store' });
    if (r2.ok) {
      const obj = await r2.json();
      // Si la lambda renvoie un â€œenregistrementâ€ sans vraies sections,
      // on re-tente le bucket (au cas oÃ¹ il soit juste lent)
      const looksThin = !obj || (
        obj.cover == null &&
        obj.arrival == null &&
        obj.neighborhood == null &&
        obj.recommendations == null &&
        obj.appliances == null
      );
      if (looksThin) {
        const r3 = await fetch(bucketUrl, { cache:'no-store' });
        if (r3.ok) return await r3.json();
      }
      return obj;
    }
  } catch (e) {
    console.warn('lambda fetch failed:', e);
  }

  throw new Error('Guide introuvable (ni bucket ni lambda).');
}


  async function boot(){
    // slug depuis lâ€™URL
    const segments = location.pathname.split('/').filter(Boolean);
    let slug = segments.pop() || '';
    slug = slug.replace(/\.html$/,'');
    const qs=new URLSearchParams(location.search);
    const token=qs.get('token')||'';
    const langParam=(qs.get('lang')||'').toLowerCase();
    if(langParam==='en') LANG='en';

    // i18n statique
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k = el.getAttribute('data-i18n');
      if (k && UI[LANG] && UI[LANG][k]) el.textContent = UI[LANG][k];
    });
    const badgeEl = document.querySelector('.badge'); if (badgeEl) badgeEl.textContent = S('traveler_guide');
    const wt = document.getElementById('welcome-title'); if (wt) wt.textContent = S('welcome_title');
    const fp = document.getElementById('footer-premium'); if (fp) fp.textContent = (LANG==='en'?'Premium Stay':'SÃ©jour Premium');

    // header actions
    const waMsg = encodeURIComponent(`${LANG==='en'?'Hello':'Bonjour'} ðŸ‘‹ (guide ${slug||'â€”'})`);
    $("btn-wa").href = `https://wa.me/212600000000?text=${waMsg}`;

    // toggle langue
    const langToggle = $("langToggle");
    langToggle.querySelectorAll('button').forEach(b=>{
      b.onclick = ()=>{
        const l=b.getAttribute('data-lang');
        const url = new URL(location.href); url.searchParams.set('lang', l);
        location.href = url.toString();
      };
      b.classList.toggle('active', b.dataset.lang===LANG);
    });

    // charge guide
    let g;
    try{
      hideAlert();
      if(!slug){ throw new Error("Slug introuvable dans l'URL."); }
      g = await fetchGuide(slug);
      // ---- Auto-provision du bien & mapping Ã  partir du JSON du bucket
try {
  const defs = g?.pricing?.defaults || g?.defaults || {};
  const name = g?.name || g?.display_name || slug;

  await sb.rpc('ensure_property_for_slug', {
    p_slug: slug,
    p_name: name,
    p_currency: defs.currency || 'MAD',
    p_base_rate: Number(defs.base) || null,
    p_min_rate: Number(defs.min) || null,
    p_max_rate: Number(defs.max) || null,
    p_cleaning_fee: Number(defs.cleaning_fee) || 0,
    p_extra_guest_fee: Number(defs.extra_guest_fee) || 0,
    p_included_guests: Number(defs.included_guests) || 2
  });
} catch (e) {
  console.warn('ensure_property_for_slug failed', e);
  // on ne bloque pas lâ€™affichage; la carte Tarifs donnera un message si pas mappÃ©
}

      console.log('[guide]', g);
    }catch(err){
      console.error(err);
      showAlert(err.message||err);
      document.title="Guide introuvable";
      $("intro-text").textContent = (LANG==='en'?'The guide could not be loaded.':'Le guide nâ€™a pas pu Ãªtre chargÃ©.');
      $("intro-card").style.display='';
      return;
    }

    /* ---------- HERO ---------- */
    (function setupHero(){
      const hero = document.getElementById('hero');
      const heroImg = document.getElementById('hero-img');
      if (!hero || !heroImg) return;
      const candidates = resolveCoverCandidates(g);
      if (!candidates.length){ hero.style.display='none'; return; }
      loadFirstWorkingImage(
        candidates,
        heroImg,
        (okUrl)=>{ hero.style.display='block'; document.getElementById('title').textContent = g.name || ''; },
        ()=>{ hero.style.display='none'; }
      );
    })();

    /* ---------- INTRO (toujours visible) ---------- */
    const introText = (()=>{
      const t = pickText(g.intro);
      const w = pickText(g.welcome);
      return t || w || S('welcome_fallback');
    })();
    const introCard = document.getElementById('intro-card');
    const introP = document.getElementById('intro-text');
    if (introCard && introP) {
      introP.innerHTML = br(introText);
      introCard.style.display = 'block';
    }

    /* ---------- DATA & CARTES ---------- */
    const allow = g.__sensitive?.token ? (token === g.__sensitive.token) : true;

    const a   = pickLang(g.arrival)   || {};
    const dep = pickLang(g.departure) || {};

    const rulesObj = pickLang(g.rules);
    const rules = Array.isArray(rulesObj) ? rulesObj : (rulesObj?.items || []);

    const ams = Array.isArray(g.amenities) ? g.amenities : [];

    const essentialsText = (()=>{
      const e = g.essentials;
      if (e == null) return '';
      if (typeof e === 'string') return e;
      return e[LANG] || e.fr || e.en || '';
    })();

    const grid = $("grid");
    grid.innerHTML = "";

    // geo
    const lat = g?.geo?.lat!=null ? parseFloat(g.geo.lat) : NaN;
    const lng = g?.geo?.lng!=null ? parseFloat(g.geo.lng) : NaN;
    const hasGeo = !Number.isNaN(lat) && !Number.isNaN(lng);

    // âœ… DÃ©claration des cartes AVANT tout cards.push
    const cards = [];

    // Localisation
    if (hasGeo){
      cards.push({
        key:S('location'), icon:'location',
        onClick: ()=>{
          openModal(S('location'), `
            <div class="mapbox">
              <iframe src="https://www.google.com/maps?q=${lat},${lng}&z=15&output=embed" width="100%" height="100%" style="border:0" loading="lazy"></iframe>
            </div>
            <div class="modal-actions">
              <a class="btn primary" target="_blank" rel="noreferrer" href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}">${S('open_gmaps')}</a>
              <a class="btn" target="_blank" rel="noreferrer" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}">${S('directions')}</a>
            </div>
          `);
        }
      });
    }

    // Quartier & Recos
    const nbh = pickLang(g.neighborhood)   || {};
    const rec = pickLang(g.recommendations) || {};
    const nbhItems = parseLines(nbh.places || []);
    const recItems = parseLines(rec.tips   || []);

    if ((nbh.intro && nbh.intro.trim()) || nbhItems.length){
      cards.push({
        key:S('neighborhood'), icon:'map',
        onClick:()=>{
          const groups = groupByCat(nbhItems);
          const pts = nbhItems.filter(i=>Number.isFinite(i.lat)&&Number.isFinite(i.lng));
          openModal(S('neighborhood'), `
            ${nbh.intro ? `<p>${br(nbh.intro)}</p>` : ''}
            ${pts.length ? `<div class="mapbox"><iframe src="https://www.google.com/maps?q=${hasGeo?`${lat},${lng}`:`${pts[0].lat},${pts[0].lng}`}&z=14&output=embed" width="100%" height="100%" style="border:0" loading="lazy"></iframe></div>`:''}
            ${Array.from(groups.entries()).map(([cat,items])=>`
              <div class="k">${cat}</div>
              <div class="list">
                ${items.map(it=>`
                  <div class="list-row">
                    <div class="dot"></div>
                    <div class="list-col">
                      <div class="list-txt">${it.text}</div>
                      ${it.url ? `<a class="pill" href="${it.url}" target="_blank" rel="noreferrer">${S('view')}</a>`:''}
                    </div>
                  </div>
                `).join('')}
              </div>
            `).join('')}
            ${hasGeo ? `
              <div class="modal-actions">
                <a class="btn" target="_blank" rel="noreferrer"
                   href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}">${S('explore_nearby')}</a>
              </div>` : ''
            }
          `);
        }
      });
    }

    if ((rec.intro && rec.intro.trim()) || recItems.length){
      cards.push({
        key:S('do_see'), icon:'map',
        onClick:()=>{
          const groups = groupByCat(recItems);
          const pts = recItems.filter(i=>Number.isFinite(i.lat)&&Number.isFinite(i.lng));
          openModal(S('do_see'), `
            ${rec.intro ? `<p>${br(rec.intro)}</p>` : ''}
            ${pts.length ? `<div class="mapbox"><iframe src="https://www.google.com/maps?q=${hasGeo?`${lat},${lng}`:`${pts[0].lat},${pts[0].lng}`}&z=13&output=embed" width="100%" height="100%" style="border:0" loading="lazy"></iframe></div>`:''}
            ${Array.from(groups.entries()).map(([cat,items])=>`
              <div class="k">${cat}</div>
              <div class="list">
                ${items.map(it=>`
                  <div class="list-row">
                    <div class="dot"></div>
                    <div class="list-col">
                      <div class="list-txt">${it.text}</div>
                      ${it.url ? `<a class="pill" href="${it.url}" target="_blank" rel="noreferrer">${S('link')}</a>`:''}
                    </div>
                  </div>
                `).join('')}
              </div>
            `).join('')}
          `);
        }
      });
    }

    // Appareils
    const appl = pickLang(g.appliances);
    if ((Array.isArray(appl) && appl.length) || (typeof appl==='string' && appl.trim())){
      cards.push({
        key:S('appliances'), icon:'amenities',
        onClick:()=>{
          let html='';
          if(Array.isArray(appl)){
            html = appl.map(x=>`
              <div class="k">${x.name||''}</div>
              ${x.tips?.length? `<ul>${x.tips.map(t=>`<li>${t}</li>`).join('')}</ul>`:''}
            `).join('');
          }else{
            const lines = (appl||'').split('\n').map(s=>s.trim()).filter(Boolean);
            html = lines.map(l=>{
              const [left,rest] = l.split('â€”').map(s=>s.trim());
              const tips = (rest||'').split(';').map(s=>s.trim()).filter(Boolean);
              return `<div class="k">${left}</div>${tips.length?`<ul>${tips.map(t=>`<li>${t}</li>`).join('')}</ul>`:''}`;
            }).join('');
          }
          openModal(S('appliances'), html || `<p>${S('no_data')}</p>`);
        }
      });
    }

    // DÃ©pannage & signalement
    const trb  = pickLang(g.troubleshoot);
    cards.push({
      key:S('help_issues'), icon:'help',
      onClick:()=>{
        let html='';
        if(Array.isArray(trb) && trb.length){
          html = trb.map(x=>`
            <div class="k">${x.title||''}</div>
            ${x.steps?.length? `<ol>${x.steps.map(t=>`<li>${t}</li>`).join('')}</ol>`:''}
          `).join('');
        }else{
          html = `<p>${LANG==='en'?'Check water heater, main breaker, and the Wi-Fi router.':'VÃ©rifiez le chauffe-eau, le disjoncteur et la box Wi-Fi.'}</p>`;
        }
        html += `
          <div class="modal-actions">
            <a class="btn" href="mailto:conciergeriezenata@gmail.com?subject=${encodeURIComponent('Support '+slug)}">${S('email')}</a>
            <a class="btn primary" target="_blank" rel="noreferrer" href="https://wa.me/212600000000?text=${encodeURIComponent((LANG==='en'?'I need help ':'Besoin dâ€™aide ')+ '(guide '+slug+')')}">${S('whatsapp')}</a>
            <button class="btn" id="btn-report">${S('report_issue')}</button>
          </div>
        `;
        openModal(S('help_issues'), html);
        const btn=document.getElementById('btn-report');
        if(btn){
          btn.onclick = async ()=>{
            const msg = prompt(LANG==='en'?'Describe the issue:':'DÃ©crivez le souci :');
            if(!msg) return;
            try{
              const r = await fetch('/.netlify/functions/report-issue',{ method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ slug, message: msg, ts: Date.now(), lang: LANG })
              });
              alert(r.ok ? S('report_thanks') : S('report_error'));
            }catch{ alert(S('network_error')); }
          };
        }
      }
    });

    // Parking
    if (a.parking || g.parking?.imageUrl){
      cards.push({
        key:S('parking_access'), icon:'map',
        onClick:()=>{
          openModal(S('parking_access'), `
            ${a.parking? `<p><b>${S('spot')} :</b> ${a.parking}</p>`:''}
            ${g.parking?.imageUrl? `<img src="${g.parking.imageUrl}" alt="Plan Parking" style="width:100%;border-radius:12px;border:1px solid var(--border);margin-top:8px">`:''}
          `);
        }
      });
    }

    // Upsells
    if (Array.isArray(g.upsells) && g.upsells.length){
      cards.push({
        key:S('extras'), icon:'amenities',
        onClick:()=>{
          const rows = g.upsells.map(u=>{
            const txt = encodeURIComponent(u.waText || (LANG==='en'?'Hello, Iâ€™d like ':'Bonjour, je souhaite ')+(u.label||''));
            return `<a class="pill" target="_blank" rel="noreferrer" href="https://wa.me/212600000000?text=${txt}">${u.label||'Option'}</a>`;
          }).join(' ');
          openModal(S('extras'), `<p>${S('book_extra')}</p>${rows}`);
        }
      });
    }

    // Ã‰lÃ©ments classiques
    cards.push(
      { key:S('address'), icon:'map', onClick:()=>openModal(S('address'), `<p>${g.address||''}</p>`) },
      { key:S('wifi'), icon:'wifi', onClick:()=>openModal('Wi-Fi', `<p><b>SSID</b> : ${a.wifi?.ssid||''}<br><b>${LANG==='en'?'Password':'Mot de passe'}</b> : ${a.wifi?.password||''}</p>`) },
      { key:S('door_code'), icon:'door', onClick:()=>openModal(S('door_code'), allow? `<p style="font-size:28px"><b>${a.doorCode||''}</b></p>` : `<p>${S('sensitive_hidden')}: <code>?token=VOTRE_TOKEN</code></p>`) },
      { key:'Check-in', icon:'checkin', onClick:()=>openModal(S('checkin'), `<p>${S('from')} <b>${a.checkin_from||''}</b></p>${a.parking?`<p><b>${S('parking')} :</b> ${a.parking}</p>`:''}${(a.notes||[]).length?`<ul>${a.notes.map(n=>`<li>${n}</li>`).join('')}</ul>`:''}`) },
      { key:S('house_rules'), icon:'rules', onClick:()=>openModal(S('house_rules'), rules.length?`<ul>${rules.map(r=>`<li>${r}</li>`).join('')}</ul>`:`<p>${S('no_rules')}</p>`) },
      { key:S('amenities'), icon:'amenities', onClick:()=>openModal(S('amenities'), ams.length? ams.map(x=>`<span class="pill" style="margin:4px 6px 0 0;">${x.label}</span>`).join('') : `<p>${S('not_provided')}</p>`) },
      { key:S('essentials'), icon:'map', onClick:()=>openModal(S('essentials'), `<p>${br(essentialsText)}</p>`) },
      { key:S('checkout'), icon:'exit', onClick:()=>openModal(S('checkout'), `<p>${S('checkout_before')} <b>${(dep.checkout_until||'11:00')}</b></p>`) },
      { key:S('support'), icon:'help', onClick:()=>openModal(S('support'), `<p><b>${S('email')} :</b> <a href="mailto:conciergeriezenata@gmail.com">conciergeriezenata@gmail.com</a></p><div class="modal-actions"><a class="btn primary" target="_blank" rel="noreferrer" href="https://wa.me/212600000000?text=${waMsg}">WhatsApp</a><a class="btn" href="tel:+212600000000">${S('call')}</a></div>`) },
    );

    /* ---------- Carte TARIFS (quote + daily) ---------- */
   cards.push({
  key: (LANG === 'en' ? 'Pricing' : 'Tarifs'),
  icon: 'amenities',
  onClick: () => {
    const today = new Date().toISOString().slice(0,10);
    const next  = new Date(Date.now()+ 3*86400000).toISOString().slice(0,10);

    openModal((LANG==='en'?'Pricing':'Tarifs'), `
      <form id="price-form" class="modal-actions" style="gap:8px;align-items:flex-end">
        <div>
          <div style="font-size:12px;color:#bbb">${LANG==='en'?'From':'Du'}</div>
          <input id="pf-from" type="date" value="${today}" style="padding:8px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:#fff"/>
        </div>
        <div>
          <div style="font-size:12px;color:#bbb">${LANG==='en'?'To':'Au'}</div>
          <input id="pf-to" type="date" value="${next}" style="padding:8px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:#fff"/>
        </div>
        <div>
          <div style="font-size:12px;color:#bbb">${LANG==='en'?'Guests':'Voyageurs'}</div>
          <input id="pf-guests" type="number" min="1" value="2" style="width:90px;padding:8px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:#fff"/>
        </div>
        <button class="btn primary" type="submit">${LANG==='en'?'Calculate':'Calculer'}</button>
      </form>

      <div id="price-result" style="margin-top:12px"></div>
      <div id="price-daily"  style="margin-top:10px"></div>
    `);

    const $res  = document.getElementById('price-result');
    const $list = document.getElementById('price-daily');
    const fmt = (n)=> new Intl.NumberFormat('fr-MA', { maximumFractionDigits: 0 }).format(Number(n||0));

    async function runQuote() {
      const from   = document.getElementById('pf-from').value;
      const to     = document.getElementById('pf-to').value;
      const guests = parseInt(document.getElementById('pf-guests').value || '1', 10);

      $res.innerHTML  = `<div class="k">${LANG==='en'?'Loadingâ€¦':'Chargementâ€¦'}</div>`;
      $list.innerHTML = '';

      const { data: quote, error: qErr } = await sb.rpc('pricing_quote_by_slug', {
        p_slug: slug,
        p_from: from,
        p_to: to,
        p_guests: guests,
        p_apply_length_discounts: true,
        p_weekend_iso_days: [6,7]
      });
      if (qErr) { $res.innerHTML = `<div class="error-box">${qErr.message || qErr}</div>`; return; }

      const row = Array.isArray(quote) ? quote[0] : quote;
      const nights   = row?.nights ?? 0;
      const subtotal = Number(row?.subtotal ?? 0);
      const clean    = Number(row?.cleaning_fee ?? 0);
      const extra    = Number(row?.extra_guest_fee_total ?? row?.extra_guests_fee_total ?? 0);
      const total    = Number(row?.total ?? subtotal + clean + extra);

      $res.innerHTML = `
        <div class="tile" style="align-items:flex-start;min-height:auto">
          <div style="font-size:14px;margin-bottom:6px"><b>${nights}</b> ${LANG==='en'?'nights':'nuits'}</div>
          <div class="list">
            <div class="list-row"><div class="dot"></div><div class="list-txt">${LANG==='en'?'Subtotal':'Sous-total'}: <b>${fmt(subtotal)}</b></div></div>
            <div class="list-row"><div class="dot"></div><div class="list-txt">${LANG==='en'?'Cleaning fee':'Frais mÃ©nage'}: <b>${fmt(clean)}</b></div></div>
            <div class="list-row"><div class="dot"></div><div class="list-txt">${LANG==='en'?'Extra guests':'SupplÃ©ment voyageurs'}: <b>${fmt(extra)}</b></div></div>
            <div class="list-row"><div class="dot"></div><div class="list-txt">Total: <b>${fmt(total)}</b></div></div>
          </div>
        </div>
      `;

      const { data: daily, error: dErr } = await sb.rpc('pricing_daily_by_slug', {
        p_slug: slug, p_from: from, p_to: to, p_weekend_iso_days: [6,7]
      });
      if (dErr) { $list.innerHTML = `<div class="error-box">${dErr.message || dErr}</div>`; return; }
      if (!daily || !daily.length) { $list.innerHTML = `<div class="k">${LANG==='en'?'No days returned':'Aucun jour retournÃ©'}</div>`; return; }

      $list.innerHTML = `
        <div class="k" style="margin-bottom:6px">${LANG==='en'?'Daily rates':'Tarifs par jour'}</div>
        <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:6px;border:1px solid var(--border);border-radius:12px;overflow:hidden">
          <div style="padding:8px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.04)"><b>${LANG==='en'?'Date':'Date'}</b></div>
          <div style="padding:8px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.04)"><b>${LANG==='en'?'Rate':'Tarif'}</b></div>
          <div style="padding:8px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.04)"><b>${LANG==='en'?'Source':'Source'}</b></div>
          ${daily.map(d => {
            const r = (d.rate == null || d.rate === '') ? null : Number(d.rate);
            return `
              <div style="padding:8px;border-top:1px solid var(--border)">${d.day}</div>
              <div style="padding:8px;border-top:1px solid var(--border)">${r==null ? (LANG==='en'?'â€” (blackout)':'â€” (indispo)') : fmt(r)}</div>
              <div style="padding:8px;border-top:1px solid var(--border)">${d.source||''}</div>
            `;
          }).join('')}
        </div>
      `;
    } // /runQuote

    const form = document.getElementById('price-form');
    form.addEventListener('submit', (e)=>{ e.preventDefault(); runQuote(); });
    runQuote();
  } // /onClick
}); // /cards.push

    // rendu des cartes
    for(const c of cards){
      const d=document.createElement('div');
      d.className='tile';
      d.innerHTML=`${icon(c.icon)}<span>${c.key}</span>`;
      d.onclick=c.onClick;
      grid.appendChild(d);
    }
  }

  // Chat IA (optionnel, inchangÃ©)
  function initAi(){
    const fab = $("ai-fab");
    const overlay = $("ai-overlay");
    const closeBtn = $("ai-close");
    const form = $("ai-form");
    const input = $("ai-input");
    const stream = $("ai-stream");

    function open(){ overlay.setAttribute('open',''); overlay.setAttribute('aria-hidden','false'); input?.focus(); }
    function close(){ overlay.removeAttribute('open'); overlay.setAttribute('aria-hidden','true'); }
    fab?.addEventListener('click',(e)=>{e.preventDefault();open();});
    closeBtn?.addEventListener('click',(e)=>{e.preventDefault();close();});
    overlay?.addEventListener('click',(e)=>{ if(e.target===overlay) close(); });

    function push(role, html){
      const div=document.createElement('div');
      div.className='ai-msg ' + (role==='user'?'user':'bot');
      div.innerHTML=(html||'').replace(/\n/g,'<br>');
      stream.appendChild(div);
      stream.scrollTop=stream.scrollHeight;
    }

    async function ask(q){
      if(!q.trim()) return;
      push('user', q); input.value='';
      const thinking=document.createElement('div'); thinking.className='ai-msg bot'; thinking.textContent='â€¦';
      stream.appendChild(thinking); stream.scrollTop=stream.scrollHeight;
      try{
        const qs=new URLSearchParams(location.search);
        const segments = location.pathname.split('/').filter(Boolean);
        let slug = (segments.pop() || '').replace(/\.html$/,'');
        const token=qs.get('token')||''; const lang=(qs.get('lang')||LANG);
        const r=await fetch('/.netlify/functions/guide-chat',{method:'POST',headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ slug, token, lang, question:q })
        });
        const data=await r.json().catch(()=>({}));
        thinking.remove();
        if(!r.ok) throw new Error(data.error||('HTTP '+r.status));
        push('bot', data.answer || (LANG==='en'?'(No answer)':'(Pas de rÃ©ponse)'));
      }catch(e){
        thinking.remove(); push('bot', 'Erreur : '+(e.message||e));
      }
    }

    document.querySelectorAll('.ai-chip').forEach(chip=>{
      chip.addEventListener('click', (e)=>{
        e.preventDefault(); ask(chip.getAttribute('data-q')||'');
      });
    });
    form?.addEventListener('submit',(e)=>{e.preventDefault();e.stopPropagation();ask(input.value||'');});
  }

  function safeStart(){
    try{
      boot();
      initAi();
    }catch(err){
      console.error(err);
      showAlert(err.message||err);
      $("intro-text").textContent = (LANG==='en'?'The guide could not be loaded.':'Le guide nâ€™a pas pu Ãªtre chargÃ©.');
      $("intro-card").style.display='';
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', safeStart);
  } else {
    safeStart();
  }
})();
</script>
</body>
</html>
