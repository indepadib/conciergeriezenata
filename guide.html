<!--
Guide public premium – version statique sans build
- Fichier: guide.html à placer à la racine du repo (à côté de index.html)
- URL finale: https://conciergeriezenata.com/guide/<slug>
- Nécessite un fichier _redirects (à la racine) avec:
    /guide/*   /guide.html?slug=:splat   200

- Lit le JSON public dans Supabase Storage: https://<SUPABASE_URL>/storage/v1/object/public/guides/<slug>.json
- Gestion du token: /guide/<slug>?token=XXXX pour afficher les champs sensibles
- Aucun framework, aucune clé d'API requise pour la lecture (public)

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guide Voyageur – Conciergerie Zenata</title>
  <meta name="theme-color" content="#0f172a"/>
  <style>
    :root{--ink:#0f172a;--muted:#475569;--line:#e2e8f0;--bg:#ffffff;--card:#f8fafc;--brand:#111827}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    .container{max-width:1120px;margin:0 auto;padding:20px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand img{height:28px}
    .badge{font-size:12px;color:var(--muted)}
    .hero{border-radius:20px;overflow:hidden;border:1px solid var(--line);background:#000}
    .hero img{width:100%;height:420px;object-fit:cover;display:block;opacity:.95}
    .grid{display:grid;gap:16px}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .grid-2{grid-template-columns:1.15fr .85fr}
    @media(max-width:960px){.grid-2,.grid-3{grid-template-columns:1fr}}
    .tile{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}
    .tile .k{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:16px}
    .card .content{padding:16px}
    ul{margin:8px 0;padding-left:18px}
    .pill{display:inline-flex;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;margin:4px 6px 0 0;background:#fff}
    .muted{color:var(--muted)}
    .warn{background:#fffbeb;border:1px solid #fef3c7;color:#92400e;padding:10px 12px;border-radius:12px;font-size:13px}
    .footer{padding:28px 0;text-align:center;color:var(--muted);font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .sr{position:absolute;left:-9999px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header class="container header">
    <div class="brand"><img src="/logo/logo_officiel_couleur_picto.png" alt="CZ"> Conciergerie Zenata</div>
    <div class="badge" id="guideSlug"></div>
  </header>

  <main class="container" id="root">
    <p class="muted">Chargement du guide…</p>
  </main>

  <footer class="container footer">© <span id="year"></span> Conciergerie Zenata</footer>

  <script>
    // === CONFIG — mets simplement ton URL Supabase ici ===
    const SUPABASE_URL = "https://ojgchrqtvkwzhjvwwftd.supabase.co"; // <- la tienne
    const GUIDES_BUCKET = "guides";

    const qs = new URL(location.href);
    const slug = (qs.searchParams.get('slug') || location.pathname.split('/').filter(Boolean).pop() || '').trim();
    const token = qs.searchParams.get('token') || '';

    document.getElementById('year').textContent = new Date().getFullYear();
    document.getElementById('guideSlug').textContent = slug ? `#${slug}` : '';

    const root = document.getElementById('root');

    function html(strings, ...vals){ return strings.map((s,i)=>s+(vals[i]??'')).join(''); }

    function section(g){
      const a = g.arrival?.fr || {};
      const allow = g.__sensitive?.token ? (token === g.__sensitive.token) : true;
      const door = allow ? (a.doorCode||'') : '•••• (masqué)';
      const rules = g.rules?.fr?.items || [];
      const dep = g.departure?.fr || {};
      const ess = g.essentials?.fr || {};
      const ams = g.amenities || [];

      return html`
        <div class="grid" style="gap:18px">
          <div class="hero"><img alt="${g.name||''}" src="${g.cover?.imageUrl||''}"></div>

          <div class="grid grid-3">
            <div class="tile"><div class="k">Adresse</div><div><strong>${g.address||''}</strong></div></div>
            <div class="tile"><div class="k">Wi‑Fi</div><div><strong>${(a.wifi?.ssid||'')}${a.wifi?.password? ' • '+a.wifi.password: ''}</strong></div></div>
            <div class="tile"><div class="k">Code porte</div><div><strong>${door}</strong></div></div>
          </div>

          <div class="grid grid-2">
            <div class="card"><h2>Arrivée & Check‑in</h2><div class="content">
              <div><span class="muted">À partir de</span> <strong>${a.checkin_from||''}</strong></div>
              ${a.parking? `<div><span class="muted">Parking</span> <strong>${a.parking}</strong></div>`:''}
              ${(a.notes||[]).length? `<ul>${(a.notes||[]).map(n=>`<li>${n}</li>`).join('')}</ul>`:''}
            </div></div>

            <div class="card"><h2>Règles</h2><div class="content"><ul>${rules.map(r=>`<li>${r}</li>`).join('')}</ul></div></div>

            <div class="card"><h2>Départ & Check‑out</h2><div class="content">
              ${dep.checkout_until? `<div><span class="muted">Avant</span> <strong>${dep.checkout_until}</strong></div>`:''}
              ${(dep.steps||[]).length? `<ul>${dep.steps.map(s=>`<li>${s.label}</li>`).join('')}</ul>`:''}
            </div></div>

            <div class="card"><h2>Infos utiles</h2><div class="content">
              ${ess.electricity? `<div><span class="muted">Électricité</span> ${ess.electricity}</div>`:''}
              ${ess.water? `<div><span class="muted">Eau</span> ${ess.water}</div>`:''}
              ${(ess.emergency||[]).map(c=>`<div><span class="muted">${c.label}</span> ${c.href? `<a href="${c.href}">${c.value}</a>`: c.value}</div>`).join('')}
            </div></div>

            ${ams.length? `<div class="card" style="grid-column:1/-1"><h2>Équipements</h2><div class="content">${ams.map(a=>`<span class="pill">${a.label||''}</span>`).join('')}</div></div>`:''}
          </div>

          ${g.coords? html`<div class="card"><h2>Plan & accès</h2><div class="content">
            <iframe title="map" style="width:100%;height:340px;border:1px solid var(--line);border-radius:12px" loading="lazy" referrerpolicy="no-referrer-when-downgrade"
              src="https://www.google.com/maps?q=${g.coords.lat},${g.coords.lng}&hl=fr&z=15&output=embed"></iframe>
          </div></div>`:''}

          ${g.brand?.supportPhone || g.brand?.supportWhatsApp || g.brand?.supportEmail ? html`<div class="card"><h2>Assistance</h2><div class="content actions">
            ${g.brand?.supportPhone? `<a class="btn" href="tel:${g.brand.supportPhone}">Appeler</a>`:''}
            ${g.brand?.supportWhatsApp? `<a class="btn" target="_blank" rel="noreferrer" href="${g.brand.supportWhatsApp}">WhatsApp 24/7</a>`:''}
            ${g.brand?.supportEmail? `<a class="btn" href="mailto:${g.brand.supportEmail}">Email</a>`:''}
            <button class="btn" onclick="window.print()">Télécharger en PDF</button>
          </div></div>`:''}

          ${g.__sensitive?.token && token !== g.__sensitive.token ? `<div class="warn">Certaines informations sensibles sont masquées. Ajoutez votre jeton à l’URL : <code>?token=VOTRE_TOKEN</code></div>`:''}
        </div>`;
    }

    async function boot(){
      if(!slug){
        root.innerHTML = '<div class="warn">Slug manquant. Utilisez /guide/<em>votre-slug</em></div>';
        return;
      }
      const jsonUrl = `${SUPABASE_URL}/storage/v1/object/public/${GUIDES_BUCKET}/${encodeURIComponent(slug)}.json`;
      try{
        const r = await fetch(jsonUrl, { cache:'no-store' });
        if(!r.ok){
          if(r.status === 404){
            root.innerHTML = `<div class="warn">Guide introuvable pour <b>${slug}</b>.<br>Vérifiez que <code>${jsonUrl}</code> existe dans le bucket <b>${GUIDES_BUCKET}</b>.</div>`;
            return;
          }
          throw new Error(`HTTP ${r.status}`);
        }
        const g = await r.json();
        const title = g?.name || `Guide ${slug}`;
        document.title = `${title} – Conciergerie Zenata`;
        root.innerHTML = html`
          <div class="header" style="padding:0 0 10px 0;">
            <div>
              <div class="badge">Guide</div>
              <h1 style="margin:.2rem 0 0 .0;font-size:28px">${title}</h1>
            </div>
          </div>
          ${section(g)}
        `;
      }catch(e){
        root.innerHTML = `<div class="warn">Erreur de chargement: ${e.message||e}</div>`;
      }
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html> -->
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Guide Voyageur – Conciergerie Zenata</title>
<meta name="robots" content="noindex,nofollow"/>
<link rel="icon" href="/logo/logo_officiel_couleur_picto.png"/>

<style>
:root{
  --bg1:#0d0e11; --bg2:#1a1b1f;
  --ink:#f5f5f5; --muted:#a3a3a3;
  --accent:#c7a059;
  --card:rgba(255,255,255,.05);
  --border:rgba(255,255,255,.08);
  --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.5);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,system-ui,sans-serif;color:var(--ink);
  background:radial-gradient(1000px 700px at 20% -10%, var(--bg2), var(--bg1) 80%);
  min-height:100vh; padding:28px;
}
.wrap{max-width:1200px;margin:0 auto}
.header{display:flex;align-items:center;gap:12px;margin-bottom:24px}
.header img{height:34px;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4))}
.header .spacer{flex:1}
.header .btn{margin-left:6px}

.lang-toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.lang-toggle button{background:transparent;color:#ddd;border:0;padding:8px 12px;cursor:pointer}
.lang-toggle button.active{background:rgba(255,255,255,.1);color:#fff}

.hero{position:relative;overflow:hidden;border-radius:var(--radius);height:400px;margin-bottom:30px;border:1px solid var(--border);box-shadow:var(--shadow)}
.hero img{width:100%;height:100%;object-fit:cover;filter:brightness(.85)}
.hero .overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0) 50%,rgba(0,0,0,.65) 100%)}
.hero .title{position:absolute;bottom:24px;left:28px;right:28px;color:#fff}
.hero .title .badge{background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);color:#fff;font-size:12px;border-radius:999px;padding:4px 10px;display:inline-block;margin-bottom:8px}
.hero .title h1{margin:0;font-size:34px;font-weight:700;letter-spacing:.3px}

.intro-card{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); backdrop-filter:blur(12px);
  text-align:center; padding:40px 28px; margin-bottom:40px;
}
.intro-card h2{font-size:22px;margin-bottom:10px;color:var(--accent)}
.intro-card p{color:var(--muted);max-width:840px;margin:0 auto 8px;line-height:1.65}
.intro-card a{color:var(--accent);text-decoration:none}
.intro-card a:hover{text-decoration:underline}

.grid{
  display:grid; gap:18px;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  margin-bottom:40px;
}
.tile{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  box-shadow:var(--shadow); backdrop-filter:blur(10px);
  padding:28px 20px; display:flex; flex-direction:column; align-items:center; justify-content:center;
  cursor:pointer; transition:all .25s ease; text-align:center;
}
.tile:hover{ transform:translateY(-3px); background:rgba(255,255,255,.08) }
.tile svg{ width:34px;height:34px;margin-bottom:12px;stroke:var(--accent);stroke-width:1.7 }
.tile span{ font-size:15px; font-weight:600; letter-spacing:.3px }

.modal{ position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center; padding:24px; z-index:50 }
.modal[open]{ display:flex }
.modal-card{
  background:linear-gradient(180deg,#121317 0%,#0d0e11 100%);
  border:1px solid var(--border); border-radius:var(--radius);
  max-width:860px; width:100%; box-shadow:var(--shadow); color:#f8f8f8
}
.modal-head{ display:flex; align-items:center; gap:10px; justify-content:space-between; border-bottom:1px solid var(--border); padding:16px 20px }
.modal-head strong{ font-size:18px }
.modal-close{ background:transparent; border:1px solid var(--border); border-radius:999px; color:#ccc; padding:6px 12px; cursor:pointer }
.modal-body{ padding:22px 20px 24px; font-size:15px; line-height:1.6 }
.modal-body .mapbox{ height:420px; border-radius:14px; overflow:hidden; border:1px solid var(--border); box-shadow:inset 0 0 0 1px rgba(255,255,255,.02) }
.modal-actions{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap }
.btn{ appearance:none; border:1px solid var(--border); background:rgba(255,255,255,.06); color:#eee; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; gap:8px }
.btn.primary{ background:linear-gradient(135deg,#0F172A,#1F2937); border:none }

.footer{ text-align:center; color:var(--muted); margin-top:40px; font-size:13px }
.footer .btn{margin-top:10px}

/* listes premium */
.list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
.list-row{display:flex;gap:10px;align-items:flex-start}
.dot{width:8px;height:8px;border-radius:999px;background:#C7A059;position:relative;top:8px;flex-shrink:0}
.list-col{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.list-txt{font-size:14px;line-height:1.45}
.pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);
      border-radius:999px;text-decoration:none;font-size:12px;color:#fff;background:rgba(255,255,255,.06)}
.pill:hover{background:rgba(255,255,255,.12)}
.k{font-size:12px;color:#bbb;margin-top:6px}

    /*css chatbot */
.cz-chat{position:fixed;right:18px;bottom:18px;z-index:60}
.cz-chat-fab{width:56px;height:56px;border-radius:50%;border:1px solid rgba(255,255,255,.12);
  background:linear-gradient(135deg,#0F172A,#1F2937);color:#fff;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.cz-chat-box{position:absolute;right:0;bottom:70px;width:340px;max-height:70vh;display:flex;flex-direction:column;
  background:rgba(0,0,0,.6);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden}
.cz-chat-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.12);color:#eee}
.cz-chat-stream{padding:10px;display:flex;flex-direction:column;gap:8px;overflow:auto}
.cz-chat-msg{padding:10px 12px;border:1px solid rgba(255,255,255,.1);border-radius:12px;max-width:85%}
.cz-chat-msg.user{align-self:flex-end;background:rgba(255,255,255,.08)}
.cz-chat-msg.bot{align-self:flex-start;background:rgba(255,255,255,.04)}
.cz-chat-form{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.12)}
.cz-chat-form input{flex:1;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;background:rgba(255,255,255,.06);color:#fff}
.cz-send{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.08);color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.cz-chat-suggest{display:flex;gap:8px;padding:8px 10px;flex-wrap:wrap}
.cz-chip{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}

/* print */
@media print{
  body{ background:#fff; color:#000; padding:0 }
  .header, .lang-toggle, .modal, .btn{ display:none !important }
  .hero{ height:300px; border:none; box-shadow:none }
  .tile, .intro-card{ box-shadow:none }
  a{ color:#000; text-decoration:none }
}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <img src="/logo/logo_officiel_couleur_picto.png" alt="Zenata">
    <strong>Conciergerie Zenata</strong>
    <div class="spacer"></div>

    <!-- Toggle FR/EN -->
    <div class="lang-toggle" id="langToggle">
      <button data-lang="fr" class="active">FR</button>
      <button data-lang="en">EN</button>
    </div>

    <!-- Contact rapide -->
    <a class="btn" id="btn-wa" target="_blank" rel="noreferrer">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor"><path d="M20 12a8 8 0 10-14.32 4.906L4 21l4.2-1.1A8 8 0 1020 12z"/><path d="M7.5 8.5c.5 4 4 6 6.5 6.5l1.5-1.5"/></svg>
      WhatsApp
    </a>
    <a class="btn" id="btn-call" href="tel:+212600000000" data-i18n="call">Appeler</a>
    <button class="btn" onclick="window.print()" data-i18n="pdf">PDF</button>
  </div>

  <div id="hero" class="hero" style="display:none">
    <img id="hero-img" alt="">
    <div class="overlay"></div>
    <div class="title"><div class="badge" data-i18n="traveler_guide">Guide voyageur</div><h1 id="title"></h1></div>
  </div>

  <!-- Bloc Introduction & Accueil -->
  <div id="intro-card" class="intro-card" style="display:none">
    <h2 id="welcome-title">Bienvenue à Zenata 🌴</h2>
    <p id="intro-text"></p>
    <p><b>Email :</b> <a href="mailto:conciergeriezenata@gmail.com">conciergeriezenata@gmail.com</a></p>
  </div>

  <div id="grid" class="grid"></div>

  <div class="footer">
    © <span id="year"></span> Conciergerie Zenata — <span id="footer-premium">Séjour Premium</span>
    <br/>
    <button class="btn" onclick="window.print()" data-i18n="download_pdf">Télécharger en PDF</button>
  </div>
</div>

<!-- Modale -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <strong id="m-title">Détail</strong>
      <button class="modal-close" id="m-close" data-i18n="close">Fermer</button>
    </div>
    <div class="modal-body" id="m-body"></div>
  </div>
</div>

<script>
/* ===== i18n ===== */
let LANG='fr';
const UI = {
  fr: {
    traveler_guide: "Guide voyageur",
    call: "Appeler",
    pdf: "PDF",
    download_pdf: "Télécharger en PDF",
    welcome_title: "Bienvenue à Zenata 🌴",
    welcome_fallback: "Nous sommes ravis de vous accueillir à Zenata. Profitez de votre séjour.",
    location: "Localisation",
    open_gmaps: "Ouvrir dans Google Maps",
    directions: "Itinéraire",
    explore_nearby: "Explorer autour",
    neighborhood: "Quartier",
    do_see: "À faire / Recos",
    link: "Lien",
    view: "Voir",
    address: "Adresse",
    wifi: "Wi-Fi",
    door_code: "Code porte",
    sensitive_hidden: "Infos sensibles masquées. Ajoutez votre jeton",
    checkin: "Arrivée & Check-in",
    from: "À partir de",
    parking: "Parking",
    house_rules: "Règles",
    no_rules: "Aucune règle.",
    amenities: "Équipements",
    not_provided: "Non renseigné.",
    essentials: "Essentiels",
    checkout: "Départ",
    checkout_before: "Check-out avant",
    support: "Assistance & Contact",
    email: "Email",
    whatsapp: "WhatsApp",
    report_issue: "Signaler un souci",
    help_issues: "Dépannage",
    report_thanks: "Merci, c’est envoyé.",
    report_error: "Erreur",
    network_error: "Erreur réseau",
    appliances: "Appareils & Mode d’emploi",
    no_data: "Non renseigné.",
    parking_access: "Parking & Accès",
    spot: "Emplacement",
    extras: "Services additionnels",
    book_extra: "Réserver un extra :",
    detail: "Détail"
  },
  en: {
    traveler_guide: "Traveler Guide",
    call: "Call",
    pdf: "PDF",
    download_pdf: "Download PDF",
    welcome_title: "Welcome to Zenata 🌴",
    welcome_fallback: "We’re delighted to host you in Zenata. Enjoy your stay.",
    location: "Location",
    open_gmaps: "Open in Google Maps",
    directions: "Directions",
    explore_nearby: "Explore nearby",
    neighborhood: "Neighborhood",
    do_see: "Do & See",
    link: "Link",
    view: "View",
    address: "Address",
    wifi: "Wi-Fi",
    door_code: "Door code",
    sensitive_hidden: "Sensitive info hidden. Add your token",
    checkin: "Arrival & Check-in",
    from: "From",
    parking: "Parking",
    house_rules: "House rules",
    no_rules: "No rules.",
    amenities: "Amenities",
    not_provided: "Not provided.",
    essentials: "Essentials",
    checkout: "Checkout",
    checkout_before: "Check-out before",
    support: "Support",
    email: "Email",
    whatsapp: "WhatsApp",
    report_issue: "Report an issue",
    help_issues: "Help & Issues",
    report_thanks: "Thanks, we got it.",
    report_error: "Error",
    network_error: "Network error",
    appliances: "Appliances",
    no_data: "No data.",
    parking_access: "Parking & Access",
    spot: "Spot",
    extras: "Extras",
    book_extra: "Book an extra:",
    detail: "Detail"
  }
};
const S = (k)=> (UI[LANG] && UI[LANG][k]) || UI['fr'][k] || k;

/* ===== Helpers ===== */
const $ = (id)=>document.getElementById(id);
$("year").textContent = new Date().getFullYear();

function openModal(title, html){ $("m-title").textContent = title; $("m-body").innerHTML = html; $("modal").setAttribute("open",""); }
function closeModal(){ $("modal").removeAttribute("open"); }
$("m-close").onclick = closeModal;
$("modal").addEventListener("click", e => { if (e.target.id === "modal") closeModal(); });

function icon(name){
  const icons={
    wifi:`<svg fill="none" viewBox="0 0 24 24"><path d="M5 12a9 9 0 0114 0M2 9a12 12 0 0120 0M8.5 15.5a5 5 0 017 0M12 20h.01"/></svg>`,
    door:`<svg fill="none" viewBox="0 0 24 24"><path d="M14 12v.01M6 3h12v18H6z"/></svg>`,
    checkin:`<svg fill="none" viewBox="0 0 24 24"><path d="M3 3h18v18H3zM8 12l2 2 5-5"/></svg>`,
    map:`<svg fill="none" viewBox="0 0 24 24"><path d="M9 3l6 3 6-3v18l-6 3-6-3-6 3V3l6-3z"/></svg>`,
    rules:`<svg fill="none" viewBox="0 0 24 24"><path d="M5 5h14M5 9h14M5 13h9M5 17h9"/></svg>`,
    amenities:`<svg fill="none" viewBox="0 0 24 24"><path d="M4 6h16v12H4z"/></svg>`,
    help:`<svg fill="none" viewBox="0 0 24 24"><path d="M9 9a3 3 0 116 0c0 1.657-3 3-3 3m0 4h.01"/></svg>`,
    exit:`<svg fill="none" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4m7 4l5 5-5 5m5-5H9"/></svg>`,
    location:`<svg fill="none" viewBox="0 0 24 24"><path d="M12 21s7-4.35 7-10a7 7 0 10-14 0c0 5.65 7 10 7 10zM12 11a2 2 0 110-4 2 2 0 010 4z"/></svg>`,
    neighborhood:`<svg fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="1.5" d="M12 21s7-4.35 7-10a7 7 0 10-14 0c0 5.65 7 10 7 10z"/><circle cx="12" cy="11" r="2" fill="currentColor"/></svg>`,
    activities:`<svg fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="1.5" d="M4 7h16M4 12h16M4 17h10"/><circle cx="18" cy="17" r="1.5" fill="currentColor"/></svg>`,
    appliance:`<svg fill="none" viewBox="0 0 24 24"><path d="M4 6h16v12H4zM8 9h.01M12 9h.01M16 9h.01"/></svg>`,
    wrench:`<svg fill="none" viewBox="0 0 24 24"><path d="M21 3l-6 6M3 21l6-6M3 10a7 7 0 109.9 9.9"/></svg>`,
    car:`<svg fill="none" viewBox="0 0 24 24"><path d="M3 13l2-5h14l2 5v5h-2a2 2 0 01-4 0H9a2 2 0 01-4 0H3v-5z"/></svg>`,
    cart:`<svg fill="none" viewBox="0 0 24 24"><path d="M3 4h2l2 12h10l2-8H7"/></svg>`
  };
  return icons[name] || icons.map;
}

/* Google Maps */
// window.GMAPS_API_KEY = "TA_CLE";
const darkMapStyle=[{"elementType":"geometry","stylers":[{"color":"#1f2023"}]},{"elementType":"labels.text.fill","stylers":[{"color":"#e0e0e0"}]},{"elementType":"labels.text.stroke","stylers":[{"color":"#1f2023"}]},{"featureType":"poi","elementType":"labels.text.fill","stylers":[{"color":"#c7a059"}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#1a1b1f"}]},{"featureType":"road","elementType":"geometry","stylers":[{"color":"#2a2c31"}]},{"featureType":"road","elementType":"labels.text.fill","stylers":[{"color":"#d6d6d6"}]},{"featureType":"transit","elementType":"geometry","stylers":[{"color":"#2a2c31"}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#0e1116"}]}];
function loadGoogleMapsScript(cb){
  if (window.google && window.google.maps){ cb(); return; }
  const key = window.GMAPS_API_KEY;
  if (!key){ cb(new Error('NO_KEY')); return; }
  const s=document.createElement('script');
  s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=marker`;
  s.async=true; s.onload=()=>cb(); s.onerror=()=>cb(new Error('LOAD_FAIL')); document.head.appendChild(s);
}
function renderGoogleMapJS(points, center){
  const el = document.getElementById('map-canvas'); if(!el||!window.google) return;
  const map = new google.maps.Map(el,{center:center,zoom:points.length>1?13:15,disableDefaultUI:true,styles:darkMapStyle});
  points.forEach(p=>{
    new google.maps.Marker({position:{lat:p.lat,lng:p.lng},map,
      icon:{path:google.maps.SymbolPath.CIRCLE,scale:7,fillColor:'#c7a059',fillOpacity:1,strokeColor:'#fff',strokeWeight:2},
      title:p.title||''
    });
  });
}

/* Parsing lignes: "[Catégorie] Nom — détail | url | lat,lng" */
function parseLines(arr){
  return (arr||[]).map(line=>{
    const parts = String(line).split('|').map(s=>s.trim());
    const left = parts[0]||'';
    const url = parts[1] && /^https?:\/\//i.test(parts[1]) ? parts[1] : null;
    let lat=null,lng=null;
    if(parts[2] && /-?\d+(\.\d+)?\s*,\s*-?\d+(\.\d+)?/.test(parts[2])){
      const [a,b]=parts[2].split(',').map(x=>parseFloat(x.trim())); lat=a; lng=b;
    }
    let cat=null, text=left;
    const m = left.match(/^\s*\[([^\]]+)\]\s*(.*)$/);
    if(m){ cat = m[1]; text = m[2]||''; }
    return { text, url, lat, lng, cat };
  });
}

/* Text utils & lang picking */
const br = s => (s||'').replace(/\n/g,'<br>');
function pick(obj){ if(!obj) return null; return obj[LANG] ?? obj['fr'] ?? obj['en'] ?? null; }

/* ===== Boot ===== */
async function boot(){
  const slug=(location.pathname.split('/').pop()||'').replace(/\.html$/,'');
  const qs=new URLSearchParams(location.search);
  const token=qs.get('token')||'';
  const langParam=(qs.get('lang')||'').toLowerCase();
  if(langParam==='en') LANG='en';

  // Apply static i18n on fixed labels
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k = el.getAttribute('data-i18n');
    el.textContent = S(k);
  });
  document.getElementById('welcome-title').textContent = S('welcome_title');
  document.querySelector('.badge').textContent = S('traveler_guide');
  document.getElementById('footer-premium').textContent = (LANG==='en'?'Premium Stay':'Séjour Premium');

  // Analytics soft
  try{
    const payload = JSON.stringify({ slug, lang: LANG, ts: Date.now() });
    if(navigator.sendBeacon){
      navigator.sendBeacon('/.netlify/functions/guide-view', payload);
    }else{
      fetch('/.netlify/functions/guide-view',{ method:'POST', headers:{'Content-Type':'application/json'}, body: payload });
    }
  }catch{}

  // via Netlify function pour éviter le cache
  const api = `/.netlify/functions/get-guide?slug=${encodeURIComponent(slug)}&ts=${Date.now()}`;
  let g;
  try{
    const r = await fetch(api, { cache: 'no-store' });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    g = await r.json();
  }catch(err){
    document.body.innerHTML = `<div style="color:#fff;text-align:center;padding:48px">${LANG==='en'?'Guide not found.':'Guide introuvable.'}</div>`;
    return;
  }

  // hero/title
  if(g.cover?.imageUrl){ $("hero-img").src=g.cover.imageUrl; $("hero").style.display=''; }
  $("title").textContent=g.name||'';

  // header actions
  const waMsg = encodeURIComponent(`Bonjour 👋 (guide ${slug})`);
  $("btn-wa").href = `https://wa.me/212600000000?text=${waMsg}`;

  // intro
  const intro = pick(g.intro) || pick(g.welcome) || S('welcome_fallback');
  $("intro-text").innerHTML = br(intro); $("intro-card").style.display='';

  const allow = g.__sensitive?.token ? (token===g.__sensitive.token) : true;
  const a = pick(g.arrival) || {};
  const dep = pick(g.departure) || {};
  const rules = (pick(g.rules)?.items) || [];
  const ams = g.amenities || [];

  const grid = $("grid");
  const cards = [];

  // lang toggle
  const langToggle = $("langToggle");
  langToggle.querySelectorAll('button').forEach(b=>{
    b.onclick = ()=>{
      const l=b.getAttribute('data-lang');
      const url = new URL(location.href); url.searchParams.set('lang', l);
      location.href = url.toString();
    };
    b.classList.toggle('active', b.dataset.lang===LANG);
  });

  // geo
  const lat = g?.geo?.lat!=null ? parseFloat(g.geo.lat) : NaN;
  const lng = g?.geo?.lng!=null ? parseFloat(g.geo.lng) : NaN;
  const hasGeo = !Number.isNaN(lat) && !Number.isNaN(lng);

  // Localisation
  if (hasGeo){
    cards.push({
      key:S('location'), icon:'location',
      onClick: ()=>{
        openModal(S('location'), `
          <div class="mapbox"><div id="map-canvas" style="width:100%;height:100%"></div></div>
          <div class="modal-actions">
            <a class="btn primary" target="_blank" rel="noreferrer" href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}">${S('open_gmaps')}</a>
            <a class="btn" target="_blank" rel="noreferrer" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}">${S('directions')}</a>
          </div>
        `);
        loadGoogleMapsScript((err)=>{
          if(err){
            $("m-body").innerHTML = `
              <div class="mapbox">
                <iframe src="https://www.google.com/maps?q=${lat},${lng}&z=15&output=embed" width="100%" height="100%" style="border:0" loading="lazy"></iframe>
              </div>
              <div class="modal-actions">
                <a class="btn primary" target="_blank" rel="noreferrer" href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}">${S('open_gmaps')}</a>
                <a class="btn" target="_blank" rel="noreferrer" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}">${S('directions')}</a>
              </div>
            `;
          } else {
            renderGoogleMapJS([{lat,lng,title:g.name||''}], {lat,lng});
          }
        });
      }
    });
  }

  // Quartier & Recos
  const nbh = pick(g.neighborhood) || {};
  const rec = pick(g.recommendations) || {};
  const nbhItems = parseLines(nbh.places || []);
  const recItems = parseLines(rec.tips || []);

  function groupByCat(items){
    const map = new Map();
    items.forEach(it=>{
      const key = (it.cat|| (LANG==='en'?'Others':'Autres')).trim();
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(it);
    });
    return map;
  }

  if ((nbh.intro && nbh.intro.trim()) || nbhItems.length){
    cards.push({
      key:S('neighborhood'), icon:'neighborhood',
      onClick:()=>{
        const groups = groupByCat(nbhItems);
        const pts = nbhItems.filter(i=>Number.isFinite(i.lat)&&Number.isFinite(i.lng)).map(i=>({lat:i.lat,lng:i.lng,title:i.text}));
        openModal(S('neighborhood'), `
          ${nbh.intro ? `<p>${br(nbh.intro)}</p>` : ''}
          ${pts.length ? `<div class="mapbox" style="margin-bottom:12px"><div id="map-canvas" style="width:100%;height:100%"></div></div>`:''}
          ${Array.from(groups.entries()).map(([cat,items])=>`
            <div class="k">${cat}</div>
            <div class="list">
              ${items.map(it=>`
                <div class="list-row">
                  <div class="dot"></div>
                  <div class="list-col">
                    <div class="list-txt">${it.text}</div>
                    ${it.url ? `<a class="pill" href="${it.url}" target="_blank" rel="noreferrer">${S('view')}</a>`:''}
                  </div>
                </div>
              `).join('')}
            </div>
          `).join('')}
          ${hasGeo ? `
            <div class="modal-actions">
              <a class="btn" target="_blank" rel="noreferrer"
                 href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}">${S('explore_nearby')}</a>
            </div>` : ''
          }
        `);
        if(pts.length){
          loadGoogleMapsScript((err)=>{
            if(err){
              const iframe = `<iframe src="https://www.google.com/maps?q=${lat},${lng}&z=14&output=embed" width="100%" height="100%" style="border:0" loading="lazy"></iframe>`;
              $("m-body").querySelector('.mapbox').innerHTML = iframe;
            }else{
              renderGoogleMapJS(pts, hasGeo?{lat,lng}:{lat:pts[0].lat,lng:pts[0].lng});
            }
          });
        }
      }
    });
  }

  if ((rec.intro && rec.intro.trim()) || recItems.length){
    cards.push({
      key:S('do_see'), icon:'activities',
      onClick:()=>{
        const groups = groupByCat(recItems);
        const pts = recItems.filter(i=>Number.isFinite(i.lat)&&Number.isFinite(i.lng)).map(i=>({lat:i.lat,lng:i.lng,title:i.text}));
        openModal(S('do_see'), `
          ${rec.intro ? `<p>${br(rec.intro)}</p>` : ''}
          ${pts.length ? `<div class="mapbox" style="margin-bottom:12px"><div id="map-canvas" style="width:100%;height:100%"></div></div>`:''}
          ${Array.from(groups.entries()).map(([cat,items])=>`
            <div class="k">${cat}</div>
            <div class="list">
              ${items.map(it=>`
                <div class="list-row">
                  <div class="dot"></div>
                  <div class="list-col">
                    <div class="list-txt">${it.text}</div>
                    ${it.url ? `<a class="pill" href="${it.url}" target="_blank" rel="noreferrer">${S('link')}</a>`:''}
                  </div>
                </div>
              `).join('')}
            </div>
          `).join('')}
        `);
        if(pts.length){
          loadGoogleMapsScript((err)=>{
            if(err){
              const center = hasGeo?`${lat},${lng}`:`${pts[0].lat},${pts[0].lng}`;
              const iframe = `<iframe src="https://www.google.com/maps?q=${center}&z=13&output=embed" width="100%" height="100%" style="border:0" loading="lazy"></iframe>`;
              $("m-body").querySelector('.mapbox').innerHTML = iframe;
            }else{
              renderGoogleMapJS(pts, hasGeo?{lat,lng}:{lat:pts[0].lat,lng:pts[0].lng});
            }
          });
        }
      }
    });
  }

  // Appareils
  const appl = pick(g.appliances);
  if ((Array.isArray(appl) && appl.length) || (typeof appl==='string' && appl.trim())){
    cards.push({
      key:S('appliances'), icon:'appliance',
      onClick:()=>{
        let html='';
        if(Array.isArray(appl)){
          html = appl.map(x=>`
            <div class="k">${x.name||''}</div>
            ${x.tips?.length? `<ul>${x.tips.map(t=>`<li>${t}</li>`).join('')}</ul>`:''}
          `).join('');
        }else{
          const lines = (appl||'').split('\n').map(s=>s.trim()).filter(Boolean);
          html = lines.map(l=>{
            const [left,rest] = l.split('—').map(s=>s.trim());
            const tips = (rest||'').split(';').map(s=>s.trim()).filter(Boolean);
            return `<div class="k">${left}</div>${tips.length?`<ul>${tips.map(t=>`<li>${t}</li>`).join('')}</ul>`:''}`;
          }).join('');
        }
        openModal(S('appliances'), html || `<p>${S('no_data')}</p>`);
      }
    });
  }

  // Dépannage + signalement
  const trb = pick(g.troubleshoot);
  cards.push({
    key:S('help_issues'), icon:'wrench',
    onClick:()=>{
      let html='';
      if(Array.isArray(trb) && trb.length){
        html = trb.map(x=>`
          <div class="k">${x.title||''}</div>
          ${x.steps?.length? `<ol>${x.steps.map(t=>`<li>${t}</li>`).join('')}</ol>`:''}
        `).join('');
      }else{
        html = `<p>${LANG==='en'?'Check water heater, main breaker, and router.':'Vérifiez le chauffe-eau, le disjoncteur et la box Wi-Fi.'}</p>`;
      }
      html += `
        <div class="modal-actions">
          <a class="btn" href="mailto:conciergeriezenata@gmail.com?subject=${encodeURIComponent('Support '+slug)}">${S('email')}</a>
          <a class="btn primary" target="_blank" rel="noreferrer" href="https://wa.me/212600000000?text=${encodeURIComponent('Besoin d’aide (guide '+slug+')')}">${S('whatsapp')}</a>
          <button class="btn" id="btn-report">${S('report_issue')}</button>
        </div>
      `;
      openModal(S('help_issues'), html);
      const btn=$("btn-report");
      if(btn){
        btn.onclick = async ()=>{
          const msg = prompt(LANG==='en'?'Describe the issue:':'Décrivez le souci :');
          if(!msg) return;
          try{
            const r = await fetch('/.netlify/functions/report-issue',{ method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ slug, message: msg, ts: Date.now(), lang: LANG })
            });
            alert(r.ok ? S('report_thanks') : S('report_error'));
          }catch{ alert(S('network_error')); }
        };
      }
    }
  });

  // Parking
  if (a.parking || g.parking?.imageUrl){
    cards.push({
      key:S('parking_access'), icon:'car',
      onClick:()=>{
        openModal(S('parking_access'), `
          ${a.parking? `<p><b>${S('spot')} :</b> ${a.parking}</p>`:''}
          ${g.parking?.imageUrl? `<img src="${g.parking.imageUrl}" alt="Plan Parking" style="width:100%;border-radius:12px;border:1px solid var(--border);margin-top:8px">`:''}
        `);
      }
    });
  }

  // Upsells
  if (Array.isArray(g.upsells) && g.upsells.length){
    cards.push({
      key:S('extras'), icon:'cart',
      onClick:()=>{
        const rows = g.upsells.map(u=>{
          const txt = encodeURIComponent(u.waText || (LANG==='en'?'Hello, I’d like ':'Bonjour, je souhaite ')+(u.label||''));
          return `<a class="pill" target="_blank" rel="noreferrer" href="https://wa.me/212600000000?text=${txt}">${u.label||'Option'}</a>`;
        }).join(' ');
        openModal(S('extras'), `<p>${S('book_extra')}</p>${rows}`);
      }
    });
  }

  // Éléments existants
  cards.push(
    { key:S('address'), icon:'map', onClick:()=>openModal(S('address'), `<p>${g.address||''}</p>`) },
    { key:S('wifi'), icon:'wifi', onClick:()=>openModal('Wi-Fi', `<p><b>SSID</b> : ${a.wifi?.ssid||''}<br><b>Password</b> : ${a.wifi?.password||''}</p>`) },
    { key:S('door_code'), icon:'door', onClick:()=>openModal(S('door_code'), allow? `<p style="font-size:28px"><b>${a.doorCode||''}</b></p>` : `<p>${S('sensitive_hidden')}: <code>?token=VOTRE_TOKEN</code></p>`) },
    { key:'Check-in', icon:'checkin', onClick:()=>openModal(S('checkin'), `<p>${S('from')} <b>${a.checkin_from||''}</b></p>${a.parking?`<p><b>${S('parking')} :</b> ${a.parking}</p>`:''}${(a.notes||[]).length?`<ul>${a.notes.map(n=>`<li>${n}</li>`).join('')}</ul>`:''}`) },
    { key:S('house_rules'), icon:'rules', onClick:()=>openModal(S('house_rules'), rules.length?`<ul>${rules.map(r=>`<li>${r}</li>`).join('')}</ul>`:`<p>${S('no_rules')}</p>`) },
    { key:S('amenities'), icon:'amenities', onClick:()=>openModal(S('amenities'), ams.length? ams.map(x=>`<span class="pill" style="margin:4px 6px 0 0;">${x.label}</span>`).join('') : `<p>${S('not_provided')}</p>`) },
    { key:S('essentials'), icon:'map', onClick:()=>openModal(S('essentials'), `<p>${br((pick(g.essentials) || ''))}</p>`) },
    { key:S('checkout'), icon:'exit', onClick:()=>openModal(S('checkout'), `<p>${S('checkout_before')} <b>${(dep.checkout_until||'11:00')}</b></p>`) },
    { key:S('support'), icon:'help', onClick:()=>openModal(S('support'), `<p><b>${S('email')} :</b> <a href="mailto:conciergeriezenata@gmail.com">conciergeriezenata@gmail.com</a></p><div class="modal-actions"><a class="btn primary" target="_blank" rel="noreferrer" href="https://wa.me/212600000000?text=${waMsg}">WhatsApp</a><a class="btn" href="tel:+212600000000">${S('call')}</a></div>`) },
  );

  for(const c of cards){
    const d=document.createElement('div');
    d.className='tile';
    d.innerHTML=`${icon(c.icon)}<span>${c.key}</span>`;
    d.onclick=c.onClick;
    grid.appendChild(d);
  }
}

document.addEventListener('DOMContentLoaded', boot);

// --- Chat Concierge ---
(function(){
  const qs = new URLSearchParams(location.search);
  const slug = (location.pathname.split('/').pop()||'').replace(/\.html$/,'');
  const token = qs.get('token') || '';
  const langParam = (qs.get('lang')||'').toLowerCase();
  const LANG = (langParam==='en') ? 'en' : 'fr';

  const $ = id => document.getElementById(id);
  const box = $('cz-chat-box'), fab = $('cz-chat-toggle'), closeBtn = $('cz-chat-close');
  const stream = $('cz-chat-stream'), form = $('cz-chat-form'), input = $('cz-chat-input');
  const chips = Array.from(document.querySelectorAll('.cz-chip'));
  $('cz-chat-lang').textContent = LANG.toUpperCase();

  function push(role, text){
    const div = document.createElement('div');
    div.className = 'cz-chat-msg ' + (role==='user'?'user':'bot');
    div.innerHTML = text.replace(/\n/g,'<br>');
    stream.appendChild(div);
    stream.scrollTop = stream.scrollHeight;
  }

  async function ask(q){
    if(!q.trim()) return;
    push('user', q);
    input.value = '';
    const thinking = document.createElement('div');
    thinking.className='cz-chat-msg bot';
    thinking.textContent = (LANG==='en'?'Thinking…':'Réflexion…');
    stream.appendChild(thinking); stream.scrollTop = stream.scrollHeight;

    try{
      const r = await fetch('/.netlify/functions/guide-chat', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ slug, token, lang: LANG, question: q })
      });
      const data = await r.json();
      thinking.remove();
      if(!r.ok) throw new Error(data.error||('HTTP '+r.status));
      push('bot', data.answer || (LANG==='en'?'(No answer)':'(Pas de réponse)'));
    }catch(e){
      thinking.remove();
      push('bot', (LANG==='en'?'Error: ':'Erreur : ')+(e.message||e));
    }
  }

  fab.onclick = ()=>{ box.hidden = !box.hidden; if(!box.hidden) input.focus(); };
  closeBtn.onclick = ()=>{ box.hidden = true; };
  form.addEventListener('submit', e=>{ e.preventDefault(); ask(input.value); });
  chips.forEach(c => c.onclick = ()=> ask(c.getAttribute('data-q')||''));
})();
</script>

    <!-- Chat Concierge -->
<div id="cz-chat" class="cz-chat">
  <button id="cz-chat-toggle" class="cz-chat-fab">💬</button>
  <div id="cz-chat-box" class="cz-chat-box" hidden>
    <div class="cz-chat-head">
      <div>Concierge Zenata · <span id="cz-chat-lang">FR</span></div>
      <button id="cz-chat-close">✕</button>
    </div>
    <div id="cz-chat-stream" class="cz-chat-stream"></div>
    <div class="cz-chat-suggest">
      <button class="cz-chip" data-q="Wi-Fi password? / Mot de passe Wi-Fi ?">Wi-Fi ?</button>
      <button class="cz-chip" data-q="Check-in time / Heure de check-in">Check-in</button>
      <button class="cz-chip" data-q="Best restaurants nearby / Meilleurs restos">Restos</button>
    </div>
    <form id="cz-chat-form" class="cz-chat-form">
      <input id="cz-chat-input" placeholder="Pose ta question…" autocomplete="off"/>
      <button class="cz-send" aria-label="Envoyer">↩︎</button>
    </form>
  </div>
</div>

</body>
</html>
