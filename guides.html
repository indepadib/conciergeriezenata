<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Guides – Conciergerie Zenata</title>
  <style>
    :root{
      --ink:#0B1220; --muted:#6B7280; --line:#E7ECF3; --bg:#FAFBFF; --card:#FFFFFF;
      --brand:#0F172A; --accent:#0EA5E9; --radius:14px; --shadow:0 12px 28px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:linear-gradient(180deg,#fff 0%, #F7F9FC 100%)}
    .container{max-width:1120px;margin:0 auto;padding:20px}
    .nav{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(8px);
         border-bottom:1px solid var(--line)}
    .row{display:flex;align-items:center;gap:12px}
    .spacer{flex:1}
    .title{font-weight:800;letter-spacing:.2px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px}
    .content{padding:16px}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    input[type="search"]{padding:12px;border:1px solid var(--line);border-radius:12px;min-width:280px}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;font-size:12px}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.ghost{background:transparent}

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px;border-bottom:1px solid var(--line);font-size:14px}
    th{background:#F1F5F9;text-align:left}
    tr:last-child td{border-bottom:none}
    .muted{color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .url{max-width:520px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:inline-block;vertical-align:bottom}
  </style>
</head>
<body>
  <!-- header -->
  <div class="nav">
    <div class="container row">
      <div class="row"><img src="/logo/logo_officiel_couleur_picto.png" alt="" style="height:26px"><span class="title">Conciergerie Zenata — Guides</span></div>
      <div class="spacer"></div>
      <a class="btn" href="/admin-guides.html">+ Nouveau guide</a>
    </div>
  </div>

  <main class="container">
    <div class="card">
      <h2>Guides publiés</h2>
      <div class="content">
        <div class="controls">
          <input type="search" id="q" placeholder="Rechercher par slug…">
          <button class="btn" id="refresh">Actualiser</button>
          <span id="msg" class="muted"></span>
        </div>

        <div style="border:1px solid var(--line);border-radius:16px;overflow:hidden">
          <table id="tbl">
            <thead>
              <tr><th style="width:200px">Slug</th><th>URL publique (JSON)</th><th style="width:340px">Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script>
    async function listGuides(){
      const res = await fetch('/.netlify/functions/list-guides');
      if(!res.ok) throw new Error(await res.text());
      return await res.json(); // { objects: [{name, publicUrl}] }
    }

    function draw(rows){
      const q = (document.getElementById('q').value || '').toLowerCase();
      const tb = document.querySelector('#tbl tbody');
      tb.innerHTML = '';

      rows
        .filter(r => !q || r.name.toLowerCase().includes(q))
        .forEach(r => {
          const tr = document.createElement('tr');
          const pub = r.publicUrl;
          const guideLink = `/guide/${r.name}`;
          const editLink  = `/admin-guides.html?slug=${encodeURIComponent(r.name)}`;
          tr.innerHTML = `
            <td><b>${r.name}</b></td>
            <td><a class="url" href="${pub}" target="_blank" rel="noreferrer">${pub}</a></td>
            <td>
              <div class="actions">
                <a class="btn" href="${guideLink}" target="_blank" rel="noreferrer">Ouvrir</a>
                <a class="btn" href="${editLink}">Éditer</a>
                <button class="btn" data-copy="${pub}">Copier JSON</button>
              </div>
            </td>`;
          tb.appendChild(tr);
        });

      document.querySelectorAll('[data-copy]').forEach(b => {
        b.addEventListener('click', async e => {
          try{
            await navigator.clipboard.writeText(e.currentTarget.getAttribute('data-copy'));
            const old = e.currentTarget.textContent;
            e.currentTarget.textContent = 'Copié !';
            setTimeout(() => e.currentTarget.textContent = old, 1000);
          }catch{}
        });
      });
    }

    async function boot(){
      document.getElementById('msg').textContent = '';
      try{
        const r = await listGuides();
        draw(r.objects || []);
      }catch(e){
        document.getElementById('msg').textContent = 'Erreur: ' + (e.message || e);
      }
    }

    document.getElementById('refresh').addEventListener('click', boot);
    document.getElementById('q').addEventListener('input', boot);
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
