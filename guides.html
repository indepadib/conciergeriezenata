<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Guides ‚Äì Conciergerie Zenata</title>
<style>
:root {
  --ink:#0B1220; --muted:#6B7280; --line:#E5E7EB;
  --bg:#F8FAFC; --card:#FFFFFF; --brand:#C7A059;
  --radius:14px; --shadow:0 10px 25px rgba(0,0,0,.06);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--ink);background:linear-gradient(180deg,#FAFBFC 0%,#EEF2F7 100%);
  min-height:100vh;padding:24px;}
.container{max-width:1080px;margin:0 auto}
h1{font-size:26px;font-weight:700;margin-bottom:16px;color:var(--brand)}
.controls{display:flex;gap:10px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
input[type="search"]{padding:10px 14px;border:1px solid var(--line);border-radius:var(--radius);flex:1;min-width:200px}
.btn{appearance:none;border:1px solid var(--line);background:var(--card);
  border-radius:var(--radius);padding:10px 14px;cursor:pointer;font-size:14px;
  font-weight:600;transition:all .2s ease;}
.btn:hover{background:#F3F4F6}
.btn.primary{background:linear-gradient(135deg,#0F172A,#1F2937);color:#fff;border:none;}
.btn.primary:hover{opacity:.9;}
.btn.danger{border:1px solid #fee2e2;background:#fff5f5;color:#b91c1c;}
.btn.danger:hover{background:#ffecec;}
.table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);
  border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);}
th,td{padding:12px 14px;border-bottom:1px solid var(--line);font-size:14px}
th{background:#F9FAFB;text-align:left;font-weight:600;color:var(--muted)}
tr:last-child td{border-bottom:none}
.muted{font-size:13px;color:var(--muted);margin-top:8px}
a{text-decoration:none;color:#0F172A;}
a:hover{text-decoration:underline}
footer{margin-top:40px;font-size:12px;color:var(--muted);text-align:center}
@media(max-width:640px){th,td{font-size:13px;padding:10px}}
</style>
</head>

<body>
<main class="container">
  <h1>üìò Guides publi√©s ‚Äì <span style="color:#111">Conciergerie Zenata</span></h1>
  <div class="controls">
    <input type="search" id="q" placeholder="Rechercher un guide (slug)‚Ä¶"/>
    <button class="btn" id="refresh">Actualiser</button>
    <a class="btn primary" href="/admin-guides.html">+ Nouveau guide</a>
  </div>
  <div id="msg" class="muted"></div>
  <table class="table" id="tbl">
    <thead>
      <tr><th>Slug</th><th>URL publique</th><th style="width:260px">Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <footer>¬© Conciergerie Zenata ‚Äì Gestion Locative &amp; Conciergerie Premium</footer>
</main>

<script>
// === Fonctions Netlify ===
async function listGuides(){
  const res=await fetch('/.netlify/functions/list-guides');
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}

async function deleteGuide(slug){
  const res=await fetch('/.netlify/functions/delete-guide',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({slug})
  });
  const txt=await res.text();
  if(!res.ok) throw new Error(txt||'delete failed');
  return JSON.parse(txt);
}

// === UI ===
function draw(rows){
  const q=(document.getElementById('q').value||'').toLowerCase();
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
  rows
    .filter(r=>!q || r.name.toLowerCase().includes(q))
    .sort((a,b)=>a.name.localeCompare(b.name))
    .forEach(r=>{
      const pub=r.publicUrl;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><b>${r.name}</b></td>
        <td><a href="${pub}" target="_blank" rel="noreferrer">${pub}</a></td>
        <td style="display:flex;gap:6px;flex-wrap:wrap">
          <a class="btn" href="/guide/${r.name}" target="_blank">Ouvrir</a>
          <button class="btn" data-copy="${pub}">Copier URL</button>
          <button class="btn danger" data-del="${r.name}">Supprimer</button>
        </td>`;
      tb.appendChild(tr);
    });

  // copier URL
  document.querySelectorAll('[data-copy]').forEach(b=>{
    b.onclick=async(e)=>{
      const el=e.currentTarget; const txt=el.getAttribute('data-copy');
      await navigator.clipboard.writeText(txt);
      el.textContent='‚úÖ Copi√©'; setTimeout(()=>el.textContent='Copier URL',1200);
    };
  });

  // suppression
  document.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick=async(e)=>{
      const slug=e.currentTarget.getAttribute('data-del');
      if(!confirm(`‚ùå Supprimer d√©finitivement "${slug}" ?\nLe guide et son image seront retir√©s.`)) return;
      const msg=document.getElementById('msg');
      msg.textContent='Suppression en cours‚Ä¶';
      try{
        await deleteGuide(slug);
        msg.textContent='‚úÖ Guide supprim√© avec succ√®s';
        boot(); // refresh
      }catch(err){
        msg.textContent='‚ùå '+(err.message||err);
      }
    };
  });
}

async function boot(){
  const msg=document.getElementById('msg');
  msg.textContent='Chargement‚Ä¶';
  try{
    const r=await listGuides();
    draw(r.objects||[]);
    msg.textContent=`${(r.objects||[]).length} guide(s) trouv√©(s).`;
  }catch(e){
    msg.textContent='Erreur: '+(e.message||e);
  }
}

document.getElementById('refresh').addEventListener('click', boot);
document.getElementById('q').addEventListener('input', boot);
document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
