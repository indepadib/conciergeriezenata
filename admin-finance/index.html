<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Finance ‚Äî Conciergerie Zenata</title>
  <link rel="stylesheet" href="./finance.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- LOGIN -->
<div id="login" class="auth">
  <div class="auth-card">
    <div class="auth-brand">
      <div class="logo">CZ</div>
      <div>
        <div class="auth-title">Finance Admin</div>
        <div class="auth-sub">Connexion admin ‚Ä¢ simple et s√©curis√©</div>
      </div>
    </div>

    <div class="field">
      <label>Email</label>
      <input id="authEmail" type="email" placeholder="admin@conciergeriezenata.com" autocomplete="email"/>
    </div>

    <div class="field">
      <label>Mot de passe</label>
      <input id="authPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>
    </div>

    <div class="auth-actions">
      <button id="btnLogin" class="btn btn-primary">Se connecter</button>
      <button id="btnMagic" class="btn">Recevoir un lien</button>
    </div>

    <div id="authMsg" class="muted"></div>

    <div class="auth-help">
      <div class="muted">Si tu n‚Äôarrives pas √† te connecter :</div>
      <ul class="muted">
        <li>V√©rifie que ton user est dans <b>admin_users</b>.</li>
        <li>V√©rifie URL + ANON KEY Supabase.</li>
        <li>Si besoin, utilise ‚ÄúRecevoir un lien‚Äù.</li>
      </ul>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="app hidden">
  <aside class="sidebar">
    <div class="side-top">
      <div class="brand">
        <div class="logo">CZ</div>
        <div>
          <div class="title">Finance</div>
          <div id="whoami" class="subtitle">‚Äî</div>
        </div>
      </div>
    </div>

  <nav class="nav">
  <button class="nav-item active" data-tab="overview">üìå R√©sum√©</button>
  <button class="nav-item" data-tab="properties">üè† Biens</button>
  <button class="nav-item" data-tab="expenses">üß∞ D√©penses</button>
  <button class="nav-item" data-tab="closing">üßæ Cl√¥ture du mois</button>
  <button class="nav-item" data-tab="owners">üë§ Propri√©taires</button>
  <button class="nav-item" data-tab="cash">üè¶ Tr√©sorerie</button>
  <button class="nav-item" data-tab="settings">‚öôÔ∏è R√©glages</button>
</nav>


    <div class="side-bottom">
      <button id="btnLogout" class="btn btn-ghost wfull">D√©connexion</button>
    </div>
  </aside>

  <main class="main">
    <header class="header">
      <div>
        <h1 id="pageTitle">R√©sum√©</h1>
        <div id="pageSub" class="muted">Les chiffres importants, sans jargon.</div>
      </div>
      <div class="header-actions">
        <button id="btnReload" class="btn">Rafra√Æchir</button>
      </div>
    </header>

    <!-- OVERVIEW -->
    <section id="tab-overview" class="tab">
      <div class="cards">
        <div class="card">
          <div class="card-label">Ce que Zenata a gagn√© (commission)</div>
          <div id="kpiRevenue" class="card-value">‚Äî</div>
          <div class="muted">Bas√© sur les factures Zenata</div>
        </div>
        <div class="card">
          <div class="card-label">Ce que tu dois aux propri√©taires</div>
          <div id="kpiOwnerDebt" class="card-value">‚Äî</div>
          <div class="muted">Solde ledger propri√©taires</div>
        </div>
        <div class="card">
          <div class="card-label">Cash Zenata (banque)</div>
          <div id="kpiCash" class="card-value">‚Äî</div>
          <div class="muted">Somme des comptes de tr√©sorerie</div>
        </div>
        <div class="card">
          <div class="card-label">Closings √† faire (ce mois)</div>
          <div id="kpiPending" class="card-value">‚Äî</div>
          <div class="muted">Biens sans cl√¥ture verrouill√©e</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <h2>√Ä faire maintenant</h2>
          <div class="muted">3 actions maximum, claires.</div>
        </div>
        <div id="todo" class="todo"></div>
      </div>
    </section>

    <!-- CLOSING -->
    <section id="tab-closing" class="tab hidden">
  <div class="panel">
    <div class="panel-head">
      <div>
        <h2>Cl√¥ture du mois</h2>
        <div class="muted">Choisir ‚Üí v√©rifier ‚Üí valider. Tout est calcul√© automatiquement.</div>
      </div>
    </div>

    <!-- STEP 1 -->
    <div class="card">
      <h3>1) Choisir</h3>
      <div class="grid2">
        <div class="field">
          <label>Bien</label>
          <select id="cProperty"></select>
        </div>
        <div class="field">
          <label>Mois</label>
          <input id="cMonth" type="month"/>
        </div>
      </div>
    </div>

    <!-- STEP 2 -->
    <div class="card">
      <h3>2) Revenus plateformes</h3>
      <div class="grid2">
        <div>
          <h4>Airbnb</h4>
          <div class="field">
            <label>Revenu logement</label>
            <input id="airbnbHousing" type="number" step="0.01"/>
          </div>
          <div class="field">
            <label>Frais plateforme</label>
            <input id="airbnbFees" type="number" step="0.01"/>
          </div>
        </div>
        <div>
          <h4>Booking</h4>
          <div class="field">
            <label>Revenu logement</label>
            <input id="bookingHousing" type="number" step="0.01"/>
          </div>
          <div class="field">
            <label>Frais plateforme</label>
            <input id="bookingFees" type="number" step="0.01"/>
          </div>
        </div>
      </div>
      <div class="muted" id="revTotalMsg"></div>
    </div>

    <!-- STEP 3 -->
    <div class="card">
      <h3>3) D√©ductions</h3>
      <div class="grid2">
        <div class="field">
          <label>Consommables (ce mois)</label>
          <input id="cConsumables" type="number" step="0.01"/>
          <div class="hint">Pr√©-rempli avec le forfait du bien. Modifiable pour ce mois.</div>
        </div>
        <div class="field">
          <label>D√©penses refacturables</label>
          <input id="cExpenses" type="number" step="0.01" disabled/>
        </div>
      </div>
    </div>

    <!-- STEP 4 -->
    <div class="card highlight">
      <h3>4) R√©sum√© propri√©taire</h3>
      <div class="summary">
        <div><span>Revenus logement</span><b id="sHousing">‚Äî</b></div>
        <div><span>Commission Zenata (20%)</span><b id="sCommission">‚Äî</b></div>
        <div><span>Consommables</span><b id="sConsumables">‚Äî</b></div>
        <div><span>D√©penses</span><b id="sExpenses">‚Äî</b></div>
        <hr/>
        <div class="total"><span>√Ä verser au propri√©taire</span><b id="sNet">‚Äî</b></div>
      </div>
    </div>

    <!-- ACTION -->
    <div class="actions">
      <button id="btnCloseMonth" class="btn btn-primary">Valider la cl√¥ture du mois</button>
      <button id="btnOwnerStatement" class="btn">T√©l√©charger relev√© propri√©taire</button>
      <button id="btnMarkPaid" class="btn">Marquer comme pay√©</button>
      <span id="closeMsg" class="muted"></span>
    </div>
  </div>
</section>

   <section id="tab-expenses" class="tab hidden">
  <div class="panel">
    <div class="panel-head line">
      <div>
        <h2>D√©penses (biens)</h2>
        <div class="muted">Ajoute une d√©pense en 10 secondes. Justificatif optionnel. üîí si mois verrouill√©.</div>
      </div>
      <div class="head-actions">
        <button id="btnNewExpense" class="btn btn-primary">+ Ajouter</button>
      </div>
    </div>

    <div class="filters">
      <div class="field">
        <label>Bien</label>
        <select id="fProperty"></select>
      </div>
      <div class="field">
        <label>Mois</label>
        <input id="fMonth" type="month"/>
      </div>
      <div class="field">
        <label>Recherche</label>
        <input id="fSearch" placeholder="Rideau, ampoule, linge, d√©pannage‚Ä¶"/>
      </div>
      <div class="field">
        <label>Type</label>
        <select id="fBillable">
          <option value="all">Tout</option>
          <option value="billable">Refactur√©e au propri√©taire</option>
          <option value="not_billable">Non refactur√©e</option>
        </select>
      </div>
    </div>

    <div class="divider"></div>

    <div class="tablewrap">
      <table class="table table-soft" id="tblExpensesV2">
        <thead>
          <tr>
            <th>Date</th>
            <th>Bien</th>
            <th>Description</th>
            <th>Montant</th>
            <th>Refactur√©</th>
            <th>Justif</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="muted" id="expListMsg" style="margin-top:10px;"></div>
  </div>

  <!-- MODAL -->
  <div id="expModal" class="modal hidden">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div id="modalTitle" class="modal-title">Ajouter une d√©pense</div>
          <div class="muted">Choisis le bien, le montant, et ajoute un justificatif si tu l‚Äôas.</div>
        </div>
        <button class="btn btn-ghost" data-close="1">‚úï</button>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Bien</label>
          <select id="mProperty"></select>
        </div>
        <div class="field">
          <label>Date</label>
          <input id="mDate" type="date"/>
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Montant (MAD)</label>
          <input id="mAmount" type="number" step="0.01" placeholder="Ex: 250"/>
        </div>
        <div class="field">
          <label>Refacturer au propri√©taire ?</label>
          <select id="mBillToOwner">
            <option value="true">Oui</option>
            <option value="false">Non</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>Description</label>
        <input id="mDesc" placeholder="Ex: R√©paration rideau salon"/>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Marge propri√©taire (ex: 0.10 = +10%)</label>
          <input id="mMarkup" type="number" step="0.01" value="0"/>
          <div class="hint">Optionnel. Laisse 0 si tu ne prends pas de marge sur l‚Äôachat.</div>
        </div>

        <div class="field">
          <label>Justificatif (PDF/JPG/PNG)</label>
          <input id="mFile" type="file" accept=".pdf,.jpg,.jpeg,.png"/>
          <div class="hint">Tu peux ajouter plus tard si besoin.</div>
        </div>
      </div>

      <div class="modal-actions">
        <button id="btnSaveExpense" class="btn btn-primary">Enregistrer</button>
        <button id="btnDeleteExpense" class="btn danger hidden">Supprimer</button>
        <div id="mMsg" class="muted"></div>
      </div>
    </div>
  </div>
</section>

    <section id="tab-properties" class="tab hidden">
  <div class="panel">
    <div class="panel-head">
      <h2>Biens</h2>
      <div class="muted">Tout est g√©r√© par bien : consommables, d√©penses, cl√¥ture.</div>
    </div>

    <div class="field">
      <label>Recherche</label>
      <input id="propSearch" placeholder="Nom du bien‚Ä¶"/>
    </div>

    <div class="tablewrap">
      <table class="table" id="tblProps">
        <thead>
          <tr>
            <th>Bien</th>
            <th>Propri√©taire</th>
            <th>Consommables (forfait)</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</section>

    <!-- OWNERS -->
    <section id="tab-owners" class="tab hidden">
      <div class="panel">
        <div class="panel-head">
          <h2>Propri√©taires</h2>
          <div class="muted">Tu vois directement qui doit recevoir combien.</div>
        </div>

        <div class="field">
          <label>Recherche</label>
          <input id="ownerSearch" placeholder="Nom, email, t√©l√©phone‚Ä¶"/>
        </div>

        <div class="card">
  <h3>√Ä payer</h3>
  <div class="muted" id="toPayMsg"></div>

  <div class="tablewrap">
    <table class="table table-soft" id="tblToPay">
      <thead>
        <tr>
          <th>Propri√©taire</th>
          <th>Bien</th>
          <th>Mois</th>
          <th>Montant</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="card">
  <h3>Pay√©</h3>
  <div class="muted" id="paidMsg"></div>

  <div class="tablewrap">
    <table class="table table-soft" id="tblPaid">
      <thead>
        <tr>
          <th>Propri√©taire</th>
          <th>Bien</th>
          <th>Mois</th>
          <th>Montant</th>
          <th>Pay√© le</th>
          <th>R√©f</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>


        <div class="tablewrap">
          <table class="table" id="tblOwners">
            <thead><tr><th>Nom</th><th>Email</th><th>Balance (MAD)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CASH -->
    <section id="tab-cash" class="tab hidden">
      <div class="panel">
        <div class="panel-head">
          <h2>Tr√©sorerie</h2>
          <div class="muted">Combien on a en banque et d‚Äôo√π √ßa vient.</div>
        </div>

        <div class="tablewrap">
          <table class="table" id="tblCash">
            <thead><tr><th>Compte</th><th>Balance</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="tab-dashboard" class="tab">
  <div class="grid4">
    <div class="kpi"><span>Revenus logement</span><b id="kpiHousing">‚Äî</b></div>
    <div class="kpi"><span>Commission Zenata</span><b id="kpiCommission">‚Äî</b></div>
    <div class="kpi"><span>√Ä verser propri√©taires</span><b id="kpiToPay">‚Äî</b></div>
    <div class="kpi"><span>Marge Zenata</span><b id="kpiMargin">‚Äî</b></div>
  </div>
</section>


    <!-- SETTINGS -->
    <section id="tab-settings" class="tab hidden">
      <div class="panel">
        <div class="panel-head">
          <h2>R√©glages</h2>
          <div class="muted">Commission, consommables, r√®gles‚Ä¶</div>
        </div>

        <div class="rows">
          <div class="row">
            <span class="muted">Commission (par d√©faut)</span>
            <span><b>20%</b> hors m√©nage</span>
          </div>
          <div class="row">
            <span class="muted">Consommables</span>
            <span>Forfait mensuel par bien (dans finance_settings)</span>
          </div>
        </div>

        <div class="divider"></div>
        <div class="muted">Les r√©glages avanc√©s (TVA, mod√®les de contrat, exports compta) arrivent ensuite.</div>
      </div>
    </section>

  </main>
</div>

<script src="./finance.js"></script>
</body>
</html>
