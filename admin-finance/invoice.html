<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Facture</title>
  <style>
    :root{ --ink:#0b1220; --muted:#5b6576; --line:#e6e9f0; --bg:#f6f7fb; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--ink);}
    .wrap{ max-width: 920px; margin: 20px auto; padding: 0 12px;}
    .bar{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px;}
    .btn{ border:1px solid #d7dbe6; background:#fff; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700;}
    .paper{ background:#fff; border:1px solid var(--line); border-radius:18px; padding:22px; box-shadow: 0 10px 30px rgba(0,0,0,.06);}
    .top{ display:flex; justify-content:space-between; gap:18px; align-items:flex-start;}
    .brand{ display:flex; gap:12px; align-items:center;}
    .logo{ width:44px; height:44px; border-radius:14px; background:#0b1220; color:#fff; display:grid; place-items:center; font-weight:900;}
    h1{ margin:0; font-size:18px;}
    .muted{ color: var(--muted); font-size:12px; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px;}
    .box{ border:1px solid var(--line); border-radius:14px; padding:12px;}
    .box h3{ margin:0 0 6px 0; font-size:12px; color: var(--muted); text-transform:uppercase; letter-spacing:.6px;}
    .row{ display:flex; justify-content:space-between; gap:10px; font-size:13px; margin:6px 0;}
    table{ width:100%; border-collapse:collapse; margin-top:14px; }
    th,td{ border-bottom:1px solid var(--line); padding:10px 8px; font-size:13px; text-align:left;}
    th{ color: var(--muted); font-weight:700; background:#fafbff;}
    .totals{ margin-top:14px; display:flex; justify-content:flex-end;}
    .totals .box{ width:320px;}
    .big{ font-size:18px; font-weight:900;}
    .note{ margin-top:12px; font-size:12px; color:var(--muted);}
    @media print{
      body{ background:#fff; }
      .bar{ display:none; }
      .wrap{ margin:0; max-width:none; padding:0;}
      .paper{ border:none; box-shadow:none; border-radius:0; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="muted">Facture — impression PDF</div>
      <div style="display:flex; gap:10px;">
        <button class="btn" onclick="window.print()">Imprimer / PDF</button>
        <button class="btn" onclick="window.close()">Fermer</button>
      </div>
    </div>

    <div class="paper">
      <div class="top">
        <div class="brand">
          <div class="logo">CZ</div>
          <div>
            <h1>Conciergerie Zenata</h1>
            <div class="muted">Facturation propriétaire — Module Finance</div>
            <div class="muted" id="czMeta">—</div>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="muted">Facture N°</div>
          <div class="big" id="invNo">—</div>
          <div class="muted" id="invPeriod">—</div>
        </div>
      </div>

      <div class="grid">
        <div class="box">
          <h3>Facturé à</h3>
          <div id="billTo" class="muted">—</div>
        </div>
        <div class="box">
          <h3>Bien</h3>
          <div id="propBox" class="muted">—</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Description</th>
            <th style="text-align:right;">Qté</th>
            <th style="text-align:right;">PU</th>
            <th style="text-align:right;">Total</th>
          </tr>
        </thead>
        <tbody id="lines"></tbody>
      </table>

      <div class="totals">
        <div class="box">
          <div class="row"><span class="muted">Sous-total</span><span id="subtotal">—</span></div>
          <div class="row"><span class="muted">Taxes</span><span id="tax">—</span></div>
          <div class="row" style="margin-top:10px;"><span class="big">Total</span><span class="big" id="total">—</span></div>
        </div>
      </div>

      <div class="note" id="notes">—</div>
    </div>
  </div>

<script>
const SUPABASE_URL = "YOUR_SUPABASE_URL";
const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const money = (n)=> Number(n||0).toLocaleString('fr-MA',{minimumFractionDigits:2,maximumFractionDigits:2})+" MAD";

async function run(){
  const id = new URLSearchParams(location.search).get('id');
  if(!id){ document.body.innerHTML = "Missing invoice id"; return; }

  const { data: inv, error } = await supabase
    .from('invoices')
    .select('id,invoice_number,period_start,period_end,subtotal,tax_total,total,notes, owners(full_name,email,phone,address), properties(name,address,city)')
    .eq('id', id)
    .single();

  if(error){ document.body.innerHTML = "Error: " + error.message; return; }

  document.getElementById('invNo').textContent = inv.invoice_number || '—';
  document.getElementById('invPeriod').textContent = `Période: ${inv.period_start} → ${inv.period_end}`;
  document.getElementById('czMeta').textContent = `Émis le ${new Date(inv.period_end).toLocaleDateString('fr-MA')}`;

  const o = inv.owners || {};
  document.getElementById('billTo').innerHTML = `
    <div><b>${o.full_name || '—'}</b></div>
    <div>${o.email || ''}</div>
    <div>${o.phone || ''}</div>
    <div>${o.address || ''}</div>
  `;

  const p = inv.properties || {};
  document.getElementById('propBox').innerHTML = `
    <div><b>${p.name || '—'}</b></div>
    <div>${p.address || ''}</div>
    <div>${p.city || ''}</div>
  `;

  const { data: lines, error: e2 } = await supabase
    .from('invoice_lines')
    .select('line_type,description,quantity,unit_price,total')
    .eq('invoice_id', id)
    .order('created_at', { ascending: true });

  if(e2){ document.body.innerHTML = "Error: " + e2.message; return; }

  const tbody = document.getElementById('lines');
  tbody.innerHTML = lines
    .filter(l => !['REVENUE_GROSS','PLATFORM_FEES'].includes(l.line_type)) // hide info lines in the bill
    .map(l => `
      <tr>
        <td>${l.description}</td>
        <td style="text-align:right;">${Number(l.quantity||1).toFixed(0)}</td>
        <td style="text-align:right;">${money(l.unit_price)}</td>
        <td style="text-align:right;"><b>${money(l.total)}</b></td>
      </tr>
    `).join('') || `<tr><td colspan="4" class="muted">Aucune ligne</td></tr>`;

  document.getElementById('subtotal').textContent = money(inv.subtotal);
  document.getElementById('tax').textContent = money(inv.tax_total);
  document.getElementById('total').textContent = money(inv.total);
  document.getElementById('notes').textContent = inv.notes || '';
}
run();
</script>
</body>
</html>
